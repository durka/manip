#include <string.h>
#include <math.h>
#include "mex.h"

/*
 * mex_forward_reovlute.c
 *
 * Translation of forward_revolute.m
 *
 * Written by Alex Burka, December 2012
 * University of Pennsylvania, GRASP Lab
 */


/*
% in 2D and 3D
%   params{1} SE(n) is the center of rotation (WRT from-object center)
%   params{2} SE(n) is the radius from the center to the moving part at theta=0
%   state     R     is the theta around the circle
function [x, Dr, Dt] = forward_revolute(params, state)
    center = params{1};
    radius = params{2};
    theta = state;
    
    n = size(center,1)-1;
    x = radius * R(theta*eye(1,n*(n-1)/2)) * center;
    
    if nargout > 1
        [ct, cr] = extract_SE(center);
        [~, rr] = extract_SE(radius);
        if length(ct) == 2
            thr = rr + theta;
            th = cr + thr;
            cthr = cos(thr);
            sthr = sin(thr);
            cth = cos(th);
            sth = sin(th);
            Dr = [ 0 0 -sth     0 0 -sth    -sth
                   0 0  cth     0 0  cth     cth
                   0 0 -cth     0 0 -cth    -cth
                   0 0 -sth     0 0 -sth    -sth ];
            Dt = [ cthr -sthr 0     1 0 -sthr*ct(1)-cthr*ct(2)      -sthr*ct(1)-cthr*ct(2)
                   sthr  cthr 0     0 1  cthr*ct(1)-sthr*ct(2)       cthr*ct(1)-sthr*ct(2) ];
        else
            ccr = cos(cr);
            scr = sin(cr);
            crr = cos(rr);
            srr = sin(rr);
            ctheta = cos(theta);
            stheta = sin(theta);
            Dr =   [ 0, 0, 0, (ccr(1)*scr(3) + ccr(2)*ccr(3)*scr(1))*(ctheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3)) + stheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3))) + (scr(1)*scr(3) - ccr(1)*ccr(2)*ccr(3))*(ctheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3)) - stheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3)))  , ccr(1)*ccr(3)*scr(2)*(ctheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3)) + stheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3))) + ccr(3)*scr(1)*scr(2)*(ctheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3)) - stheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3))) - ccr(2)*ccr(3)*crr(1)*srr(2)  , (ccr(3)*scr(1) + ccr(1)*ccr(2)*scr(3))*(ctheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3)) + stheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3))) - (ccr(1)*ccr(3) - ccr(2)*scr(1)*scr(3))*(ctheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3)) - stheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3))) + crr(1)*scr(2)*scr(3)*srr(2), 0, 0, 0, (scr(1)*scr(3) - ccr(1)*ccr(2)*ccr(3))*(ctheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1)) + stheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3))) - (ccr(1)*scr(3) + ccr(2)*ccr(3)*scr(1))*(ctheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3)) - stheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1))) + ccr(3)*scr(2)*srr(1)*srr(2), (crr(1)*crr(3)*srr(2)*stheta + crr(1)*ctheta*srr(2)*srr(3))*(ccr(1)*scr(3) + ccr(2)*ccr(3)*scr(1)) + (crr(1)*crr(3)*ctheta*srr(2) - crr(1)*srr(2)*srr(3)*stheta)*(scr(1)*scr(3) - ccr(1)*ccr(2)*ccr(3)) - ccr(3)*crr(1)*crr(2)*scr(2), (ccr(1)*scr(3) + ccr(2)*ccr(3)*scr(1))*(ctheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3)) + stheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3))) + (scr(1)*scr(3) - ccr(1)*ccr(2)*ccr(3))*(ctheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3)) - stheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3)))  , (ccr(1)*scr(3) + ccr(2)*ccr(3)*scr(1))*(ctheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3)) + stheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3))) + (scr(1)*scr(3) - ccr(1)*ccr(2)*ccr(3))*(ctheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3)) - stheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3)))
                     0, 0, 0, - (ccr(1)*scr(3) + ccr(2)*ccr(3)*scr(1))*(ctheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1)) + stheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3))) - (scr(1)*scr(3) - ccr(1)*ccr(2)*ccr(3))*(ctheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3)) - stheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1))), - ccr(1)*ccr(3)*scr(2)*(ctheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1)) + stheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3))) - ccr(3)*scr(1)*scr(2)*(ctheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3)) - stheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1))) - ccr(2)*ccr(3)*srr(1)*srr(2), (ccr(1)*ccr(3) - ccr(2)*scr(1)*scr(3))*(ctheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3)) - stheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1))) - (ccr(3)*scr(1) + ccr(1)*ccr(2)*scr(3))*(ctheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1)) + stheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3))) + scr(2)*scr(3)*srr(1)*srr(2), 0, 0, 0, (scr(1)*scr(3) - ccr(1)*ccr(2)*ccr(3))*(ctheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3)) + stheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3))) - (ccr(1)*scr(3) + ccr(2)*ccr(3)*scr(1))*(ctheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3)) - stheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3))) - ccr(3)*crr(1)*scr(2)*srr(2), (ccr(1)*scr(3) + ccr(2)*ccr(3)*scr(1))*(crr(3)*srr(1)*srr(2)*stheta + ctheta*srr(1)*srr(2)*srr(3)) + (scr(1)*scr(3) - ccr(1)*ccr(2)*ccr(3))*(crr(3)*ctheta*srr(1)*srr(2) - srr(1)*srr(2)*srr(3)*stheta) - ccr(3)*crr(2)*scr(2)*srr(1), - (ccr(1)*scr(3) + ccr(2)*ccr(3)*scr(1))*(ctheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1)) + stheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3))) - (scr(1)*scr(3) - ccr(1)*ccr(2)*ccr(3))*(ctheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3)) - stheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1))), - (ccr(1)*scr(3) + ccr(2)*ccr(3)*scr(1))*(ctheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1)) + stheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3))) - (scr(1)*scr(3) - ccr(1)*ccr(2)*ccr(3))*(ctheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3)) - stheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1)))
                     0, 0, 0, (ccr(1)*scr(3) + ccr(2)*ccr(3)*scr(1))*(srr(2)*srr(3)*stheta - crr(3)*ctheta*srr(2)) + (scr(1)*scr(3) - ccr(1)*ccr(2)*ccr(3))*(crr(3)*srr(2)*stheta + ctheta*srr(2)*srr(3))                                                                                                                                                      , ccr(2)*ccr(3)*crr(2) + ccr(1)*ccr(3)*scr(2)*(srr(2)*srr(3)*stheta - crr(3)*ctheta*srr(2)) + ccr(3)*scr(1)*scr(2)*(crr(3)*srr(2)*stheta + ctheta*srr(2)*srr(3))                                                                                                                                                                 , (ccr(3)*scr(1) + ccr(1)*ccr(2)*scr(3))*(srr(2)*srr(3)*stheta - crr(3)*ctheta*srr(2)) - (ccr(1)*ccr(3) - ccr(2)*scr(1)*scr(3))*(crr(3)*srr(2)*stheta + ctheta*srr(2)*srr(3)) - crr(2)*scr(2)*scr(3)                                                                                                                                                               , 0, 0, 0, 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                    , (scr(1)*scr(3) - ccr(1)*ccr(2)*ccr(3))*(crr(2)*srr(3)*stheta - crr(2)*crr(3)*ctheta) - (ccr(1)*scr(3) + ccr(2)*ccr(3)*scr(1))*(crr(2)*crr(3)*stheta + crr(2)*ctheta*srr(3)) - ccr(3)*scr(2)*srr(2)                                                       , (ccr(1)*scr(3) + ccr(2)*ccr(3)*scr(1))*(srr(2)*srr(3)*stheta - crr(3)*ctheta*srr(2)) + (scr(1)*scr(3) - ccr(1)*ccr(2)*ccr(3))*(crr(3)*srr(2)*stheta + ctheta*srr(2)*srr(3))                                                                                                                                                      , (ccr(1)*scr(3) + ccr(2)*ccr(3)*scr(1))*(srr(2)*srr(3)*stheta - crr(3)*ctheta*srr(2)) + (scr(1)*scr(3) - ccr(1)*ccr(2)*ccr(3))*(crr(3)*srr(2)*stheta + ctheta*srr(2)*srr(3))
                     0, 0, 0, (ccr(3)*scr(1) + ccr(1)*ccr(2)*scr(3))*(ctheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3)) - stheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3))) + (ccr(1)*ccr(3) - ccr(2)*scr(1)*scr(3))*(ctheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3)) + stheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3)))  , ccr(2)*crr(1)*scr(3)*srr(2) - scr(1)*scr(2)*scr(3)*(ctheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3)) - stheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3))) - ccr(1)*scr(2)*scr(3)*(ctheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3)) + stheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3)))  , (ccr(1)*scr(3) + ccr(2)*ccr(3)*scr(1))*(ctheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3)) - stheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3))) - (scr(1)*scr(3) - ccr(1)*ccr(2)*ccr(3))*(ctheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3)) + stheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3))) + ccr(3)*crr(1)*scr(2)*srr(2), 0, 0, 0, (ccr(3)*scr(1) + ccr(1)*ccr(2)*scr(3))*(ctheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1)) + stheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3))) - (ccr(1)*ccr(3) - ccr(2)*scr(1)*scr(3))*(ctheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3)) - stheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1))) - scr(2)*scr(3)*srr(1)*srr(2), (crr(1)*crr(3)*srr(2)*stheta + crr(1)*ctheta*srr(2)*srr(3))*(ccr(1)*ccr(3) - ccr(2)*scr(1)*scr(3)) + (crr(1)*crr(3)*ctheta*srr(2) - crr(1)*srr(2)*srr(3)*stheta)*(ccr(3)*scr(1) + ccr(1)*ccr(2)*scr(3)) + crr(1)*crr(2)*scr(2)*scr(3), (ccr(3)*scr(1) + ccr(1)*ccr(2)*scr(3))*(ctheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3)) - stheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3))) + (ccr(1)*ccr(3) - ccr(2)*scr(1)*scr(3))*(ctheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3)) + stheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3)))  , (ccr(3)*scr(1) + ccr(1)*ccr(2)*scr(3))*(ctheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3)) - stheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3))) + (ccr(1)*ccr(3) - ccr(2)*scr(1)*scr(3))*(ctheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3)) + stheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3)))
                     0, 0, 0, - (ccr(3)*scr(1) + ccr(1)*ccr(2)*scr(3))*(ctheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3)) - stheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1))) - (ccr(1)*ccr(3) - ccr(2)*scr(1)*scr(3))*(ctheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1)) + stheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3))), ccr(1)*scr(2)*scr(3)*(ctheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1)) + stheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3))) + scr(1)*scr(2)*scr(3)*(ctheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3)) - stheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1))) + ccr(2)*scr(3)*srr(1)*srr(2)  , (scr(1)*scr(3) - ccr(1)*ccr(2)*ccr(3))*(ctheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1)) + stheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3))) - (ccr(1)*scr(3) + ccr(2)*ccr(3)*scr(1))*(ctheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3)) - stheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1))) + ccr(3)*scr(2)*srr(1)*srr(2), 0, 0, 0, (ccr(3)*scr(1) + ccr(1)*ccr(2)*scr(3))*(ctheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3)) + stheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3))) - (ccr(1)*ccr(3) - ccr(2)*scr(1)*scr(3))*(ctheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3)) - stheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3))) + crr(1)*scr(2)*scr(3)*srr(2), (ccr(3)*scr(1) + ccr(1)*ccr(2)*scr(3))*(crr(3)*ctheta*srr(1)*srr(2) - srr(1)*srr(2)*srr(3)*stheta) + (ccr(1)*ccr(3) - ccr(2)*scr(1)*scr(3))*(crr(3)*srr(1)*srr(2)*stheta + ctheta*srr(1)*srr(2)*srr(3)) + crr(2)*scr(2)*scr(3)*srr(1), - (ccr(3)*scr(1) + ccr(1)*ccr(2)*scr(3))*(ctheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3)) - stheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1))) - (ccr(1)*ccr(3) - ccr(2)*scr(1)*scr(3))*(ctheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1)) + stheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3))), - (ccr(3)*scr(1) + ccr(1)*ccr(2)*scr(3))*(ctheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3)) - stheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1))) - (ccr(1)*ccr(3) - ccr(2)*scr(1)*scr(3))*(ctheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1)) + stheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3)))
                     0, 0, 0, (ccr(3)*scr(1) + ccr(1)*ccr(2)*scr(3))*(crr(3)*srr(2)*stheta + ctheta*srr(2)*srr(3)) + (ccr(1)*ccr(3) - ccr(2)*scr(1)*scr(3))*(srr(2)*srr(3)*stheta - crr(3)*ctheta*srr(2))                                                                                                                                                      , - ccr(2)*crr(2)*scr(3) - ccr(1)*scr(2)*scr(3)*(srr(2)*srr(3)*stheta - crr(3)*ctheta*srr(2)) - scr(1)*scr(2)*scr(3)*(crr(3)*srr(2)*stheta + ctheta*srr(2)*srr(3))                                                                                                                                                               , (ccr(1)*scr(3) + ccr(2)*ccr(3)*scr(1))*(crr(3)*srr(2)*stheta + ctheta*srr(2)*srr(3)) - (scr(1)*scr(3) - ccr(1)*ccr(2)*ccr(3))*(srr(2)*srr(3)*stheta - crr(3)*ctheta*srr(2)) - ccr(3)*crr(2)*scr(2)                                                                                                                                                               , 0, 0, 0, 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                    , (ccr(3)*scr(1) + ccr(1)*ccr(2)*scr(3))*(crr(2)*srr(3)*stheta - crr(2)*crr(3)*ctheta) - (ccr(1)*ccr(3) - ccr(2)*scr(1)*scr(3))*(crr(2)*crr(3)*stheta + crr(2)*ctheta*srr(3)) + scr(2)*scr(3)*srr(2)                                                       , (ccr(3)*scr(1) + ccr(1)*ccr(2)*scr(3))*(crr(3)*srr(2)*stheta + ctheta*srr(2)*srr(3)) + (ccr(1)*ccr(3) - ccr(2)*scr(1)*scr(3))*(srr(2)*srr(3)*stheta - crr(3)*ctheta*srr(2))                                                                                                                                                      , (ccr(3)*scr(1) + ccr(1)*ccr(2)*scr(3))*(crr(3)*srr(2)*stheta + ctheta*srr(2)*srr(3)) + (ccr(1)*ccr(3) - ccr(2)*scr(1)*scr(3))*(srr(2)*srr(3)*stheta - crr(3)*ctheta*srr(2))
                     0, 0, 0, ccr(1)*scr(2)*(ctheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3)) - stheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3))) - scr(1)*scr(2)*(ctheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3)) + stheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3)))                                                                            , ccr(1)*ccr(2)*(ctheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3)) + stheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3))) + ccr(2)*scr(1)*(ctheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3)) - stheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3))) + crr(1)*scr(2)*srr(2)                                   , 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                    , 0, 0, 0, ccr(1)*scr(2)*(ctheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1)) + stheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3))) + scr(1)*scr(2)*(ctheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3)) - stheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1))) + ccr(2)*srr(1)*srr(2)                                                                                     , ccr(1)*scr(2)*(crr(1)*crr(3)*ctheta*srr(2) - crr(1)*srr(2)*srr(3)*stheta) - scr(1)*scr(2)*(crr(1)*crr(3)*srr(2)*stheta + crr(1)*ctheta*srr(2)*srr(3)) - ccr(2)*crr(1)*crr(2)                                                                                     , ccr(1)*scr(2)*(ctheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3)) - stheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3))) - scr(1)*scr(2)*(ctheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3)) + stheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3)))                                                                            , ccr(1)*scr(2)*(ctheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3)) - stheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3))) - scr(1)*scr(2)*(ctheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3)) + stheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3)))
                     0, 0, 0, scr(1)*scr(2)*(ctheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1)) + stheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3))) - ccr(1)*scr(2)*(ctheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3)) - stheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1)))                                                                            , scr(2)*srr(1)*srr(2) - ccr(1)*ccr(2)*(ctheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1)) + stheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3))) - ccr(2)*scr(1)*(ctheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3)) - stheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1)))                                   , 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                    , 0, 0, 0, ccr(1)*scr(2)*(ctheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3)) + stheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3))) + scr(1)*scr(2)*(ctheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3)) - stheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3))) - ccr(2)*crr(1)*srr(2)                                                                                     , ccr(1)*scr(2)*(crr(3)*ctheta*srr(1)*srr(2) - srr(1)*srr(2)*srr(3)*stheta) - scr(1)*scr(2)*(crr(3)*srr(1)*srr(2)*stheta + ctheta*srr(1)*srr(2)*srr(3)) - ccr(2)*crr(2)*srr(1)                                                                                     , scr(1)*scr(2)*(ctheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1)) + stheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3))) - ccr(1)*scr(2)*(ctheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3)) - stheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1)))                                                                            , scr(1)*scr(2)*(ctheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1)) + stheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3))) - ccr(1)*scr(2)*(ctheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3)) - stheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1)))
                     0, 0, 0, -(sin(cr(1) + rr(3) + theta)*(cos(cr(2) + rr(2)) - cos(cr(2) - rr(2))))/2                                                                                                                                                                                                                                                                                                                                                , ccr(1)*ccr(2)*(srr(2)*srr(3)*stheta - crr(3)*ctheta*srr(2)) - crr(2)*scr(2) + ccr(2)*scr(1)*(crr(3)*srr(2)*stheta + ctheta*srr(2)*srr(3))                                                                                                                                                                                                  , 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                    , 0, 0, 0, 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                    , ccr(1)*scr(2)*(crr(2)*srr(3)*stheta - crr(2)*crr(3)*ctheta) - ccr(2)*srr(2) + scr(1)*scr(2)*(crr(2)*crr(3)*stheta + crr(2)*ctheta*srr(3))                                                                                                                                            , -(sin(cr(1) + rr(3) + theta)*(cos(cr(2) + rr(2)) - cos(cr(2) - rr(2))))/2                                                                                                                                                                                                                                                                                                                                                , -(sin(cr(1) + rr(3) + theta)*(cos(cr(2) + rr(2)) - cos(cr(2) - rr(2))))/2                                                                                                                                                                                                                                                                                                                                                     ];
            Dt =   [ - ctheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3)) - stheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3)), stheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3)) - ctheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3)), -crr(1)*srr(2), 0, 0, 0, 1, 0, 0, ct(3)*srr(1)*srr(2) - ct(2)*(ctheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3)) - stheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1))) - ct(1)*(ctheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1)) + stheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3)))  , crr(1)*(ct(2)*crr(3)*srr(2)*stheta - ct(1)*crr(3)*ctheta*srr(2) - ct(3)*crr(2) + ct(2)*ctheta*srr(2)*srr(3) + ct(1)*srr(2)*srr(3)*stheta), ct(2)*(ctheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3)) + stheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3))) - ct(1)*(ctheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3)) - stheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3))), ct(2)*(ctheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3)) + stheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3))) - ct(1)*(ctheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3)) - stheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3)))
                       ctheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1)) + stheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3))  , ctheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3)) - stheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1)), -srr(1)*srr(2), 0, 0, 0, 0, 1, 0, - ct(1)*(ctheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3)) + stheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3))) - ct(2)*(ctheta*(crr(3)*srr(1) + crr(1)*crr(2)*srr(3)) - stheta*(srr(1)*srr(3) - crr(1)*crr(2)*crr(3))) - ct(3)*crr(1)*srr(2), srr(1)*(ct(2)*crr(3)*srr(2)*stheta - ct(1)*crr(3)*ctheta*srr(2) - ct(3)*crr(2) + ct(2)*ctheta*srr(2)*srr(3) + ct(1)*srr(2)*srr(3)*stheta), ct(1)*(ctheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3)) - stheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1))) - ct(2)*(ctheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1)) + stheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3))), ct(1)*(ctheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3)) - stheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1))) - ct(2)*(ctheta*(crr(1)*srr(3) + crr(2)*crr(3)*srr(1)) + stheta*(crr(1)*crr(3) - crr(2)*srr(1)*srr(3)))
                       cos(rr(3) + theta)*srr(2)                                                                                                                  , -sin(rr(3) + theta)*srr(2)                                                                                                               , crr(2)            , 0, 0, 0, 0, 0, 1, 0                                                                                                                                                                                                                                                                                                                                            , - ct(1)*(crr(2)*srr(3)*stheta - crr(2)*crr(3)*ctheta) - ct(2)*(crr(2)*crr(3)*stheta + crr(2)*ctheta*srr(3)) - ct(3)*srr(2)                   , -srr(2)*(ct(2)*cos(rr(3) + theta) + ct(1)*sin(rr(3) + theta))                                                                                                                                                                                                                                            , -srr(2)*(ct(2)*cos(rr(3) + theta) + ct(1)*sin(rr(3) + theta))                                                                                                                                                                                                                                              ];
        end
    end
end
*/

#define IJ(m,n,i,j) ((m)[(i) + (n)*(j)])

void forward_revolute(int n, double *center, double *radius, double theta, double *x)
{
    if (n == 2) {
        IJ(x,3,0,0) = IJ(center,3,2,0)*IJ(radius,3,0,2) + IJ(center,3,0,0)*(IJ(radius,3,0,0)*cos(theta) + IJ(radius,3,0,1)*sin(theta)) + IJ(center,3,1,0)*(IJ(radius,3,0,1)*cos(theta) - IJ(radius,3,0,0)*sin(theta)) ; IJ(x,3,0,1) = IJ(center,3,2,1)*IJ(radius,3,0,2) + IJ(center,3,0,1)*(IJ(radius,3,0,0)*cos(theta) + IJ(radius,3,0,1)*sin(theta)) + IJ(center,3,1,1)*(IJ(radius,3,0,1)*cos(theta) - IJ(radius,3,0,0)*sin(theta)) ; IJ(x,3,0,2) = IJ(center,3,2,2)*IJ(radius,3,0,2) + IJ(center,3,0,2)*(IJ(radius,3,0,0)*cos(theta) + IJ(radius,3,0,1)*sin(theta)) + IJ(center,3,1,2)*(IJ(radius,3,0,1)*cos(theta) - IJ(radius,3,0,0)*sin(theta)) ; 
        IJ(x,3,1,0) = IJ(center,3,2,0)*IJ(radius,3,1,2) + IJ(center,3,0,0)*(IJ(radius,3,1,0)*cos(theta) + IJ(radius,3,1,1)*sin(theta)) + IJ(center,3,1,0)*(IJ(radius,3,1,1)*cos(theta) - IJ(radius,3,1,0)*sin(theta)) ; IJ(x,3,1,1) = IJ(center,3,2,1)*IJ(radius,3,1,2) + IJ(center,3,0,1)*(IJ(radius,3,1,0)*cos(theta) + IJ(radius,3,1,1)*sin(theta)) + IJ(center,3,1,1)*(IJ(radius,3,1,1)*cos(theta) - IJ(radius,3,1,0)*sin(theta)) ; IJ(x,3,1,2) = IJ(center,3,2,2)*IJ(radius,3,1,2) + IJ(center,3,0,2)*(IJ(radius,3,1,0)*cos(theta) + IJ(radius,3,1,1)*sin(theta)) + IJ(center,3,1,2)*(IJ(radius,3,1,1)*cos(theta) - IJ(radius,3,1,0)*sin(theta)) ; 
        IJ(x,3,2,0) = IJ(center,3,2,0)*IJ(radius,3,2,2) + IJ(center,3,0,0)*(IJ(radius,3,2,0)*cos(theta) + IJ(radius,3,2,1)*sin(theta)) + IJ(center,3,1,0)*(IJ(radius,3,2,1)*cos(theta) - IJ(radius,3,2,0)*sin(theta)) ; IJ(x,3,2,1) = IJ(center,3,2,1)*IJ(radius,3,2,2) + IJ(center,3,0,1)*(IJ(radius,3,2,0)*cos(theta) + IJ(radius,3,2,1)*sin(theta)) + IJ(center,3,1,1)*(IJ(radius,3,2,1)*cos(theta) - IJ(radius,3,2,0)*sin(theta)) ; IJ(x,3,2,2) = IJ(center,3,2,2)*IJ(radius,3,2,2) + IJ(center,3,0,2)*(IJ(radius,3,2,0)*cos(theta) + IJ(radius,3,2,1)*sin(theta)) + IJ(center,3,1,2)*(IJ(radius,3,2,1)*cos(theta) - IJ(radius,3,2,0)*sin(theta)) ; 
    } else {
        IJ(x,4,0,0) = IJ(center,4,2,0)*IJ(radius,4,0,2) + IJ(center,4,3,0)*IJ(radius,4,0,3) + IJ(center,4,0,0)*(IJ(radius,4,0,0)*cos(theta) + IJ(radius,4,0,1)*sin(theta)) + IJ(center,4,1,0)*(IJ(radius,4,0,1)*cos(theta) - IJ(radius,4,0,0)*sin(theta)) ; IJ(x,4,0,1) = IJ(center,4,2,1)*IJ(radius,4,0,2) + IJ(center,4,3,1)*IJ(radius,4,0,3) + IJ(center,4,0,1)*(IJ(radius,4,0,0)*cos(theta) + IJ(radius,4,0,1)*sin(theta)) + IJ(center,4,1,1)*(IJ(radius,4,0,1)*cos(theta) - IJ(radius,4,0,0)*sin(theta)) ; IJ(x,4,0,2) = IJ(center,4,2,2)*IJ(radius,4,0,2) + IJ(center,4,3,2)*IJ(radius,4,0,3) + IJ(center,4,0,2)*(IJ(radius,4,0,0)*cos(theta) + IJ(radius,4,0,1)*sin(theta)) + IJ(center,4,1,2)*(IJ(radius,4,0,1)*cos(theta) - IJ(radius,4,0,0)*sin(theta)) ; IJ(x,4,0,3) = IJ(center,4,2,3)*IJ(radius,4,0,2) + IJ(center,4,3,3)*IJ(radius,4,0,3) + IJ(center,4,0,3)*(IJ(radius,4,0,0)*cos(theta) + IJ(radius,4,0,1)*sin(theta)) + IJ(center,4,1,3)*(IJ(radius,4,0,1)*cos(theta) - IJ(radius,4,0,0)*sin(theta)) ; 
        IJ(x,4,1,0) = IJ(center,4,2,0)*IJ(radius,4,1,2) + IJ(center,4,3,0)*IJ(radius,4,1,3) + IJ(center,4,0,0)*(IJ(radius,4,1,0)*cos(theta) + IJ(radius,4,1,1)*sin(theta)) + IJ(center,4,1,0)*(IJ(radius,4,1,1)*cos(theta) - IJ(radius,4,1,0)*sin(theta)) ; IJ(x,4,1,1) = IJ(center,4,2,1)*IJ(radius,4,1,2) + IJ(center,4,3,1)*IJ(radius,4,1,3) + IJ(center,4,0,1)*(IJ(radius,4,1,0)*cos(theta) + IJ(radius,4,1,1)*sin(theta)) + IJ(center,4,1,1)*(IJ(radius,4,1,1)*cos(theta) - IJ(radius,4,1,0)*sin(theta)) ; IJ(x,4,1,2) = IJ(center,4,2,2)*IJ(radius,4,1,2) + IJ(center,4,3,2)*IJ(radius,4,1,3) + IJ(center,4,0,2)*(IJ(radius,4,1,0)*cos(theta) + IJ(radius,4,1,1)*sin(theta)) + IJ(center,4,1,2)*(IJ(radius,4,1,1)*cos(theta) - IJ(radius,4,1,0)*sin(theta)) ; IJ(x,4,1,3) = IJ(center,4,2,3)*IJ(radius,4,1,2) + IJ(center,4,3,3)*IJ(radius,4,1,3) + IJ(center,4,0,3)*(IJ(radius,4,1,0)*cos(theta) + IJ(radius,4,1,1)*sin(theta)) + IJ(center,4,1,3)*(IJ(radius,4,1,1)*cos(theta) - IJ(radius,4,1,0)*sin(theta)) ; 
        IJ(x,4,2,0) = IJ(center,4,2,0)*IJ(radius,4,2,2) + IJ(center,4,3,0)*IJ(radius,4,2,3) + IJ(center,4,0,0)*(IJ(radius,4,2,0)*cos(theta) + IJ(radius,4,2,1)*sin(theta)) + IJ(center,4,1,0)*(IJ(radius,4,2,1)*cos(theta) - IJ(radius,4,2,0)*sin(theta)) ; IJ(x,4,2,1) = IJ(center,4,2,1)*IJ(radius,4,2,2) + IJ(center,4,3,1)*IJ(radius,4,2,3) + IJ(center,4,0,1)*(IJ(radius,4,2,0)*cos(theta) + IJ(radius,4,2,1)*sin(theta)) + IJ(center,4,1,1)*(IJ(radius,4,2,1)*cos(theta) - IJ(radius,4,2,0)*sin(theta)) ; IJ(x,4,2,2) = IJ(center,4,2,2)*IJ(radius,4,2,2) + IJ(center,4,3,2)*IJ(radius,4,2,3) + IJ(center,4,0,2)*(IJ(radius,4,2,0)*cos(theta) + IJ(radius,4,2,1)*sin(theta)) + IJ(center,4,1,2)*(IJ(radius,4,2,1)*cos(theta) - IJ(radius,4,2,0)*sin(theta)) ; IJ(x,4,2,3) = IJ(center,4,2,3)*IJ(radius,4,2,2) + IJ(center,4,3,3)*IJ(radius,4,2,3) + IJ(center,4,0,3)*(IJ(radius,4,2,0)*cos(theta) + IJ(radius,4,2,1)*sin(theta)) + IJ(center,4,1,3)*(IJ(radius,4,2,1)*cos(theta) - IJ(radius,4,2,0)*sin(theta)) ; 
        IJ(x,4,3,0) = IJ(center,4,2,0)*IJ(radius,4,3,2) + IJ(center,4,3,0)*IJ(radius,4,3,3) + IJ(center,4,0,0)*(IJ(radius,4,3,0)*cos(theta) + IJ(radius,4,3,1)*sin(theta)) + IJ(center,4,1,0)*(IJ(radius,4,3,1)*cos(theta) - IJ(radius,4,3,0)*sin(theta)) ; IJ(x,4,3,1) = IJ(center,4,2,1)*IJ(radius,4,3,2) + IJ(center,4,3,1)*IJ(radius,4,3,3) + IJ(center,4,0,1)*(IJ(radius,4,3,0)*cos(theta) + IJ(radius,4,3,1)*sin(theta)) + IJ(center,4,1,1)*(IJ(radius,4,3,1)*cos(theta) - IJ(radius,4,3,0)*sin(theta)) ; IJ(x,4,3,2) = IJ(center,4,2,2)*IJ(radius,4,3,2) + IJ(center,4,3,2)*IJ(radius,4,3,3) + IJ(center,4,0,2)*(IJ(radius,4,3,0)*cos(theta) + IJ(radius,4,3,1)*sin(theta)) + IJ(center,4,1,2)*(IJ(radius,4,3,1)*cos(theta) - IJ(radius,4,3,0)*sin(theta)) ; IJ(x,4,3,3) = IJ(center,4,2,3)*IJ(radius,4,3,2) + IJ(center,4,3,3)*IJ(radius,4,3,3) + IJ(center,4,0,3)*(IJ(radius,4,3,0)*cos(theta) + IJ(radius,4,3,1)*sin(theta)) + IJ(center,4,1,3)*(IJ(radius,4,3,1)*cos(theta) - IJ(radius,4,3,0)*sin(theta)) ; 
    }
}

void forward_revolute_gradient(int n, double *ct, double *cr, double *rr, double theta, double *Dr, double *Dt)
{
    if (n == 2) {
        IJ(Dr,4,0,0) = 0 ; IJ(Dr,4,0,1) = 0 ; IJ(Dr,4,0,2) = -sin(cr[0] + rr[0] + theta) ; IJ(Dr,4,0,3) = 0 ; IJ(Dr,4,0,4) = 0 ; IJ(Dr,4,0,5) = -sin(cr[0] + rr[0] + theta) ; IJ(Dr,4,0,6) = -sin(cr[0] + rr[0] + theta) ; 
        IJ(Dr,4,1,0) = 0 ; IJ(Dr,4,1,1) = 0 ; IJ(Dr,4,1,2) = cos(cr[0] + rr[0] + theta)  ; IJ(Dr,4,1,3) = 0 ; IJ(Dr,4,1,4) = 0 ; IJ(Dr,4,1,5) = cos(cr[0] + rr[0] + theta)  ; IJ(Dr,4,1,6) = cos(cr[0] + rr[0] + theta)  ; 
        IJ(Dr,4,2,0) = 0 ; IJ(Dr,4,2,1) = 0 ; IJ(Dr,4,2,2) = -cos(cr[0] + rr[0] + theta) ; IJ(Dr,4,2,3) = 0 ; IJ(Dr,4,2,4) = 0 ; IJ(Dr,4,2,5) = -cos(cr[0] + rr[0] + theta) ; IJ(Dr,4,2,6) = -cos(cr[0] + rr[0] + theta) ; 
        IJ(Dr,4,3,0) = 0 ; IJ(Dr,4,3,1) = 0 ; IJ(Dr,4,3,2) = -sin(cr[0] + rr[0] + theta) ; IJ(Dr,4,3,3) = 0 ; IJ(Dr,4,3,4) = 0 ; IJ(Dr,4,3,5) = -sin(cr[0] + rr[0] + theta) ; IJ(Dr,4,3,6) = -sin(cr[0] + rr[0] + theta) ; 

        IJ(Dt,2,0,0) = cos(rr[0] + theta) ; IJ(Dt,2,0,1) = -sin(rr[0] + theta) ; IJ(Dt,2,0,2) = 0 ; IJ(Dt,2,0,3) = 1 ; IJ(Dt,2,0,4) = 0 ; IJ(Dt,2,0,5) = - ct[1]*cos(rr[0] + theta) - ct[0]*sin(rr[0] + theta) ; IJ(Dt,2,0,6) = - ct[1]*cos(rr[0] + theta) - ct[0]*sin(rr[0] + theta) ; 
        IJ(Dt,2,1,0) = sin(rr[0] + theta) ; IJ(Dt,2,1,1) = cos(rr[0] + theta)  ; IJ(Dt,2,1,2) = 0 ; IJ(Dt,2,1,3) = 0 ; IJ(Dt,2,1,4) = 1 ; IJ(Dt,2,1,5) = ct[0]*cos(rr[0] + theta) - ct[1]*sin(rr[0] + theta)   ; IJ(Dt,2,1,6) = ct[0]*cos(rr[0] + theta) - ct[1]*sin(rr[0] + theta)   ; 
    } else {
        IJ(Dr,9,0,0) = 0 ; IJ(Dr,9,0,1) = 0 ; IJ(Dr,9,0,2) = 0 ; IJ(Dr,9,0,3) = (cos(cr[0])*sin(cr[2]) + cos(cr[1])*cos(cr[2])*sin(cr[0]))*(cos(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2])) + sin(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2]))) + (sin(cr[0])*sin(cr[2]) - cos(cr[0])*cos(cr[1])*cos(cr[2]))*(cos(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2])) - sin(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2])))   ; IJ(Dr,9,0,4) = cos(cr[0])*cos(cr[2])*sin(cr[1])*(cos(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2])) + sin(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2]))) + cos(cr[2])*sin(cr[0])*sin(cr[1])*(cos(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2])) - sin(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2]))) - cos(cr[1])*cos(cr[2])*cos(rr[0])*sin(rr[1])   ; IJ(Dr,9,0,5) = (cos(cr[2])*sin(cr[0]) + cos(cr[0])*cos(cr[1])*sin(cr[2]))*(cos(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2])) + sin(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2]))) - (cos(cr[0])*cos(cr[2]) - cos(cr[1])*sin(cr[0])*sin(cr[2]))*(cos(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2])) - sin(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2]))) + cos(rr[0])*sin(cr[1])*sin(cr[2])*sin(rr[1]) ; IJ(Dr,9,0,6) = 0 ; IJ(Dr,9,0,7) = 0 ; IJ(Dr,9,0,8) = 0 ; IJ(Dr,9,0,9) = (sin(cr[0])*sin(cr[2]) - cos(cr[0])*cos(cr[1])*cos(cr[2]))*(cos(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0])) + sin(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2]))) - (cos(cr[0])*sin(cr[2]) + cos(cr[1])*cos(cr[2])*sin(cr[0]))*(cos(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2])) - sin(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0]))) + cos(cr[2])*sin(cr[1])*sin(rr[0])*sin(rr[1]) ; IJ(Dr,9,0,10) = (cos(rr[0])*cos(rr[2])*sin(rr[1])*sin(theta) + cos(rr[0])*cos(theta)*sin(rr[1])*sin(rr[2]))*(cos(cr[0])*sin(cr[2]) + cos(cr[1])*cos(cr[2])*sin(cr[0])) + (cos(rr[0])*cos(rr[2])*cos(theta)*sin(rr[1]) - cos(rr[0])*sin(rr[1])*sin(rr[2])*sin(theta))*(sin(cr[0])*sin(cr[2]) - cos(cr[0])*cos(cr[1])*cos(cr[2])) - cos(cr[2])*cos(rr[0])*cos(rr[1])*sin(cr[1]) ; IJ(Dr,9,0,11) = (cos(cr[0])*sin(cr[2]) + cos(cr[1])*cos(cr[2])*sin(cr[0]))*(cos(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2])) + sin(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2]))) + (sin(cr[0])*sin(cr[2]) - cos(cr[0])*cos(cr[1])*cos(cr[2]))*(cos(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2])) - sin(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2])))   ; IJ(Dr,9,0,12) = (cos(cr[0])*sin(cr[2]) + cos(cr[1])*cos(cr[2])*sin(cr[0]))*(cos(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2])) + sin(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2]))) + (sin(cr[0])*sin(cr[2]) - cos(cr[0])*cos(cr[1])*cos(cr[2]))*(cos(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2])) - sin(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2])))   ; 
        IJ(Dr,9,1,0) = 0 ; IJ(Dr,9,1,1) = 0 ; IJ(Dr,9,1,2) = 0 ; IJ(Dr,9,1,3) = - (cos(cr[0])*sin(cr[2]) + cos(cr[1])*cos(cr[2])*sin(cr[0]))*(cos(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0])) + sin(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2]))) - (sin(cr[0])*sin(cr[2]) - cos(cr[0])*cos(cr[1])*cos(cr[2]))*(cos(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2])) - sin(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0]))) ; IJ(Dr,9,1,4) = - cos(cr[0])*cos(cr[2])*sin(cr[1])*(cos(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0])) + sin(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2]))) - cos(cr[2])*sin(cr[0])*sin(cr[1])*(cos(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2])) - sin(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0]))) - cos(cr[1])*cos(cr[2])*sin(rr[0])*sin(rr[1]) ; IJ(Dr,9,1,5) = (cos(cr[0])*cos(cr[2]) - cos(cr[1])*sin(cr[0])*sin(cr[2]))*(cos(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2])) - sin(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0]))) - (cos(cr[2])*sin(cr[0]) + cos(cr[0])*cos(cr[1])*sin(cr[2]))*(cos(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0])) + sin(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2]))) + sin(cr[1])*sin(cr[2])*sin(rr[0])*sin(rr[1]) ; IJ(Dr,9,1,6) = 0 ; IJ(Dr,9,1,7) = 0 ; IJ(Dr,9,1,8) = 0 ; IJ(Dr,9,1,9) = (sin(cr[0])*sin(cr[2]) - cos(cr[0])*cos(cr[1])*cos(cr[2]))*(cos(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2])) + sin(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2]))) - (cos(cr[0])*sin(cr[2]) + cos(cr[1])*cos(cr[2])*sin(cr[0]))*(cos(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2])) - sin(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2]))) - cos(cr[2])*cos(rr[0])*sin(cr[1])*sin(rr[1]) ; IJ(Dr,9,1,10) = (cos(cr[0])*sin(cr[2]) + cos(cr[1])*cos(cr[2])*sin(cr[0]))*(cos(rr[2])*sin(rr[0])*sin(rr[1])*sin(theta) + cos(theta)*sin(rr[0])*sin(rr[1])*sin(rr[2])) + (sin(cr[0])*sin(cr[2]) - cos(cr[0])*cos(cr[1])*cos(cr[2]))*(cos(rr[2])*cos(theta)*sin(rr[0])*sin(rr[1]) - sin(rr[0])*sin(rr[1])*sin(rr[2])*sin(theta)) - cos(cr[2])*cos(rr[1])*sin(cr[1])*sin(rr[0]) ; IJ(Dr,9,1,11) = - (cos(cr[0])*sin(cr[2]) + cos(cr[1])*cos(cr[2])*sin(cr[0]))*(cos(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0])) + sin(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2]))) - (sin(cr[0])*sin(cr[2]) - cos(cr[0])*cos(cr[1])*cos(cr[2]))*(cos(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2])) - sin(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0]))) ; IJ(Dr,9,1,12) = - (cos(cr[0])*sin(cr[2]) + cos(cr[1])*cos(cr[2])*sin(cr[0]))*(cos(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0])) + sin(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2]))) - (sin(cr[0])*sin(cr[2]) - cos(cr[0])*cos(cr[1])*cos(cr[2]))*(cos(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2])) - sin(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0]))) ; 
        IJ(Dr,9,2,0) = 0 ; IJ(Dr,9,2,1) = 0 ; IJ(Dr,9,2,2) = 0 ; IJ(Dr,9,2,3) = (cos(cr[0])*sin(cr[2]) + cos(cr[1])*cos(cr[2])*sin(cr[0]))*(sin(rr[1])*sin(rr[2])*sin(theta) - cos(rr[2])*cos(theta)*sin(rr[1])) + (sin(cr[0])*sin(cr[2]) - cos(cr[0])*cos(cr[1])*cos(cr[2]))*(cos(rr[2])*sin(rr[1])*sin(theta) + cos(theta)*sin(rr[1])*sin(rr[2]))                                                                                                                                                       ; IJ(Dr,9,2,4) = cos(cr[1])*cos(cr[2])*cos(rr[1]) + cos(cr[0])*cos(cr[2])*sin(cr[1])*(sin(rr[1])*sin(rr[2])*sin(theta) - cos(rr[2])*cos(theta)*sin(rr[1])) + cos(cr[2])*sin(cr[0])*sin(cr[1])*(cos(rr[2])*sin(rr[1])*sin(theta) + cos(theta)*sin(rr[1])*sin(rr[2]))                                                                                                                                                                  ; IJ(Dr,9,2,5) = (cos(cr[2])*sin(cr[0]) + cos(cr[0])*cos(cr[1])*sin(cr[2]))*(sin(rr[1])*sin(rr[2])*sin(theta) - cos(rr[2])*cos(theta)*sin(rr[1])) - (cos(cr[0])*cos(cr[2]) - cos(cr[1])*sin(cr[0])*sin(cr[2]))*(cos(rr[2])*sin(rr[1])*sin(theta) + cos(theta)*sin(rr[1])*sin(rr[2])) - cos(rr[1])*sin(cr[1])*sin(cr[2])                                                                                                                                                                ; IJ(Dr,9,2,6) = 0 ; IJ(Dr,9,2,7) = 0 ; IJ(Dr,9,2,8) = 0 ; IJ(Dr,9,2,9) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ; IJ(Dr,9,2,10) = (sin(cr[0])*sin(cr[2]) - cos(cr[0])*cos(cr[1])*cos(cr[2]))*(cos(rr[1])*sin(rr[2])*sin(theta) - cos(rr[1])*cos(rr[2])*cos(theta)) - (cos(cr[0])*sin(cr[2]) + cos(cr[1])*cos(cr[2])*sin(cr[0]))*(cos(rr[1])*cos(rr[2])*sin(theta) + cos(rr[1])*cos(theta)*sin(rr[2])) - cos(cr[2])*sin(cr[1])*sin(rr[1])                                                        ; IJ(Dr,9,2,11) = (cos(cr[0])*sin(cr[2]) + cos(cr[1])*cos(cr[2])*sin(cr[0]))*(sin(rr[1])*sin(rr[2])*sin(theta) - cos(rr[2])*cos(theta)*sin(rr[1])) + (sin(cr[0])*sin(cr[2]) - cos(cr[0])*cos(cr[1])*cos(cr[2]))*(cos(rr[2])*sin(rr[1])*sin(theta) + cos(theta)*sin(rr[1])*sin(rr[2]))                                                                                                                                                       ; IJ(Dr,9,2,12) = (cos(cr[0])*sin(cr[2]) + cos(cr[1])*cos(cr[2])*sin(cr[0]))*(sin(rr[1])*sin(rr[2])*sin(theta) - cos(rr[2])*cos(theta)*sin(rr[1])) + (sin(cr[0])*sin(cr[2]) - cos(cr[0])*cos(cr[1])*cos(cr[2]))*(cos(rr[2])*sin(rr[1])*sin(theta) + cos(theta)*sin(rr[1])*sin(rr[2]))                                                                                                                                                       ; 
        IJ(Dr,9,3,0) = 0 ; IJ(Dr,9,3,1) = 0 ; IJ(Dr,9,3,2) = 0 ; IJ(Dr,9,3,3) = (cos(cr[2])*sin(cr[0]) + cos(cr[0])*cos(cr[1])*sin(cr[2]))*(cos(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2])) - sin(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2]))) + (cos(cr[0])*cos(cr[2]) - cos(cr[1])*sin(cr[0])*sin(cr[2]))*(cos(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2])) + sin(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2])))   ; IJ(Dr,9,3,4) = cos(cr[1])*cos(rr[0])*sin(cr[2])*sin(rr[1]) - sin(cr[0])*sin(cr[1])*sin(cr[2])*(cos(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2])) - sin(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2]))) - cos(cr[0])*sin(cr[1])*sin(cr[2])*(cos(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2])) + sin(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2])))   ; IJ(Dr,9,3,5) = (cos(cr[0])*sin(cr[2]) + cos(cr[1])*cos(cr[2])*sin(cr[0]))*(cos(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2])) - sin(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2]))) - (sin(cr[0])*sin(cr[2]) - cos(cr[0])*cos(cr[1])*cos(cr[2]))*(cos(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2])) + sin(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2]))) + cos(cr[2])*cos(rr[0])*sin(cr[1])*sin(rr[1]) ; IJ(Dr,9,3,6) = 0 ; IJ(Dr,9,3,7) = 0 ; IJ(Dr,9,3,8) = 0 ; IJ(Dr,9,3,9) = (cos(cr[2])*sin(cr[0]) + cos(cr[0])*cos(cr[1])*sin(cr[2]))*(cos(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0])) + sin(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2]))) - (cos(cr[0])*cos(cr[2]) - cos(cr[1])*sin(cr[0])*sin(cr[2]))*(cos(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2])) - sin(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0]))) - sin(cr[1])*sin(cr[2])*sin(rr[0])*sin(rr[1]) ; IJ(Dr,9,3,10) = (cos(rr[0])*cos(rr[2])*sin(rr[1])*sin(theta) + cos(rr[0])*cos(theta)*sin(rr[1])*sin(rr[2]))*(cos(cr[0])*cos(cr[2]) - cos(cr[1])*sin(cr[0])*sin(cr[2])) + (cos(rr[0])*cos(rr[2])*cos(theta)*sin(rr[1]) - cos(rr[0])*sin(rr[1])*sin(rr[2])*sin(theta))*(cos(cr[2])*sin(cr[0]) + cos(cr[0])*cos(cr[1])*sin(cr[2])) + cos(rr[0])*cos(rr[1])*sin(cr[1])*sin(cr[2]) ; IJ(Dr,9,3,11) = (cos(cr[2])*sin(cr[0]) + cos(cr[0])*cos(cr[1])*sin(cr[2]))*(cos(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2])) - sin(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2]))) + (cos(cr[0])*cos(cr[2]) - cos(cr[1])*sin(cr[0])*sin(cr[2]))*(cos(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2])) + sin(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2])))   ; IJ(Dr,9,3,12) = (cos(cr[2])*sin(cr[0]) + cos(cr[0])*cos(cr[1])*sin(cr[2]))*(cos(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2])) - sin(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2]))) + (cos(cr[0])*cos(cr[2]) - cos(cr[1])*sin(cr[0])*sin(cr[2]))*(cos(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2])) + sin(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2])))   ; 
        IJ(Dr,9,4,0) = 0 ; IJ(Dr,9,4,1) = 0 ; IJ(Dr,9,4,2) = 0 ; IJ(Dr,9,4,3) = - (cos(cr[2])*sin(cr[0]) + cos(cr[0])*cos(cr[1])*sin(cr[2]))*(cos(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2])) - sin(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0]))) - (cos(cr[0])*cos(cr[2]) - cos(cr[1])*sin(cr[0])*sin(cr[2]))*(cos(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0])) + sin(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2]))) ; IJ(Dr,9,4,4) = cos(cr[0])*sin(cr[1])*sin(cr[2])*(cos(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0])) + sin(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2]))) + sin(cr[0])*sin(cr[1])*sin(cr[2])*(cos(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2])) - sin(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0]))) + cos(cr[1])*sin(cr[2])*sin(rr[0])*sin(rr[1])   ; IJ(Dr,9,4,5) = (sin(cr[0])*sin(cr[2]) - cos(cr[0])*cos(cr[1])*cos(cr[2]))*(cos(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0])) + sin(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2]))) - (cos(cr[0])*sin(cr[2]) + cos(cr[1])*cos(cr[2])*sin(cr[0]))*(cos(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2])) - sin(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0]))) + cos(cr[2])*sin(cr[1])*sin(rr[0])*sin(rr[1]) ; IJ(Dr,9,4,6) = 0 ; IJ(Dr,9,4,7) = 0 ; IJ(Dr,9,4,8) = 0 ; IJ(Dr,9,4,9) = (cos(cr[2])*sin(cr[0]) + cos(cr[0])*cos(cr[1])*sin(cr[2]))*(cos(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2])) + sin(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2]))) - (cos(cr[0])*cos(cr[2]) - cos(cr[1])*sin(cr[0])*sin(cr[2]))*(cos(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2])) - sin(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2]))) + cos(rr[0])*sin(cr[1])*sin(cr[2])*sin(rr[1]) ; IJ(Dr,9,4,10) = (cos(cr[2])*sin(cr[0]) + cos(cr[0])*cos(cr[1])*sin(cr[2]))*(cos(rr[2])*cos(theta)*sin(rr[0])*sin(rr[1]) - sin(rr[0])*sin(rr[1])*sin(rr[2])*sin(theta)) + (cos(cr[0])*cos(cr[2]) - cos(cr[1])*sin(cr[0])*sin(cr[2]))*(cos(rr[2])*sin(rr[0])*sin(rr[1])*sin(theta) + cos(theta)*sin(rr[0])*sin(rr[1])*sin(rr[2])) + cos(rr[1])*sin(cr[1])*sin(cr[2])*sin(rr[0]) ; IJ(Dr,9,4,11) = - (cos(cr[2])*sin(cr[0]) + cos(cr[0])*cos(cr[1])*sin(cr[2]))*(cos(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2])) - sin(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0]))) - (cos(cr[0])*cos(cr[2]) - cos(cr[1])*sin(cr[0])*sin(cr[2]))*(cos(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0])) + sin(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2]))) ; IJ(Dr,9,4,12) = - (cos(cr[2])*sin(cr[0]) + cos(cr[0])*cos(cr[1])*sin(cr[2]))*(cos(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2])) - sin(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0]))) - (cos(cr[0])*cos(cr[2]) - cos(cr[1])*sin(cr[0])*sin(cr[2]))*(cos(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0])) + sin(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2]))) ; 
        IJ(Dr,9,5,0) = 0 ; IJ(Dr,9,5,1) = 0 ; IJ(Dr,9,5,2) = 0 ; IJ(Dr,9,5,3) = (cos(cr[2])*sin(cr[0]) + cos(cr[0])*cos(cr[1])*sin(cr[2]))*(cos(rr[2])*sin(rr[1])*sin(theta) + cos(theta)*sin(rr[1])*sin(rr[2])) + (cos(cr[0])*cos(cr[2]) - cos(cr[1])*sin(cr[0])*sin(cr[2]))*(sin(rr[1])*sin(rr[2])*sin(theta) - cos(rr[2])*cos(theta)*sin(rr[1]))                                                                                                                                                       ; IJ(Dr,9,5,4) = - cos(cr[1])*cos(rr[1])*sin(cr[2]) - cos(cr[0])*sin(cr[1])*sin(cr[2])*(sin(rr[1])*sin(rr[2])*sin(theta) - cos(rr[2])*cos(theta)*sin(rr[1])) - sin(cr[0])*sin(cr[1])*sin(cr[2])*(cos(rr[2])*sin(rr[1])*sin(theta) + cos(theta)*sin(rr[1])*sin(rr[2]))                                                                                                                                                                ; IJ(Dr,9,5,5) = (cos(cr[0])*sin(cr[2]) + cos(cr[1])*cos(cr[2])*sin(cr[0]))*(cos(rr[2])*sin(rr[1])*sin(theta) + cos(theta)*sin(rr[1])*sin(rr[2])) - (sin(cr[0])*sin(cr[2]) - cos(cr[0])*cos(cr[1])*cos(cr[2]))*(sin(rr[1])*sin(rr[2])*sin(theta) - cos(rr[2])*cos(theta)*sin(rr[1])) - cos(cr[2])*cos(rr[1])*sin(cr[1])                                                                                                                                                                ; IJ(Dr,9,5,6) = 0 ; IJ(Dr,9,5,7) = 0 ; IJ(Dr,9,5,8) = 0 ; IJ(Dr,9,5,9) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ; IJ(Dr,9,5,10) = (cos(cr[2])*sin(cr[0]) + cos(cr[0])*cos(cr[1])*sin(cr[2]))*(cos(rr[1])*sin(rr[2])*sin(theta) - cos(rr[1])*cos(rr[2])*cos(theta)) - (cos(cr[0])*cos(cr[2]) - cos(cr[1])*sin(cr[0])*sin(cr[2]))*(cos(rr[1])*cos(rr[2])*sin(theta) + cos(rr[1])*cos(theta)*sin(rr[2])) + sin(cr[1])*sin(cr[2])*sin(rr[1])                                                        ; IJ(Dr,9,5,11) = (cos(cr[2])*sin(cr[0]) + cos(cr[0])*cos(cr[1])*sin(cr[2]))*(cos(rr[2])*sin(rr[1])*sin(theta) + cos(theta)*sin(rr[1])*sin(rr[2])) + (cos(cr[0])*cos(cr[2]) - cos(cr[1])*sin(cr[0])*sin(cr[2]))*(sin(rr[1])*sin(rr[2])*sin(theta) - cos(rr[2])*cos(theta)*sin(rr[1]))                                                                                                                                                       ; IJ(Dr,9,5,12) = (cos(cr[2])*sin(cr[0]) + cos(cr[0])*cos(cr[1])*sin(cr[2]))*(cos(rr[2])*sin(rr[1])*sin(theta) + cos(theta)*sin(rr[1])*sin(rr[2])) + (cos(cr[0])*cos(cr[2]) - cos(cr[1])*sin(cr[0])*sin(cr[2]))*(sin(rr[1])*sin(rr[2])*sin(theta) - cos(rr[2])*cos(theta)*sin(rr[1]))                                                                                                                                                       ; 
        IJ(Dr,9,6,0) = 0 ; IJ(Dr,9,6,1) = 0 ; IJ(Dr,9,6,2) = 0 ; IJ(Dr,9,6,3) = cos(cr[0])*sin(cr[1])*(cos(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2])) - sin(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2]))) - sin(cr[0])*sin(cr[1])*(cos(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2])) + sin(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2])))                                                                             ; IJ(Dr,9,6,4) = cos(cr[0])*cos(cr[1])*(cos(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2])) + sin(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2]))) + cos(cr[1])*sin(cr[0])*(cos(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2])) - sin(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2]))) + cos(rr[0])*sin(cr[1])*sin(rr[1])                                    ; IJ(Dr,9,6,5) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ; IJ(Dr,9,6,6) = 0 ; IJ(Dr,9,6,7) = 0 ; IJ(Dr,9,6,8) = 0 ; IJ(Dr,9,6,9) = cos(cr[0])*sin(cr[1])*(cos(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0])) + sin(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2]))) + sin(cr[0])*sin(cr[1])*(cos(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2])) - sin(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0]))) + cos(cr[1])*sin(rr[0])*sin(rr[1])                                                                                      ; IJ(Dr,9,6,10) = cos(cr[0])*sin(cr[1])*(cos(rr[0])*cos(rr[2])*cos(theta)*sin(rr[1]) - cos(rr[0])*sin(rr[1])*sin(rr[2])*sin(theta)) - sin(cr[0])*sin(cr[1])*(cos(rr[0])*cos(rr[2])*sin(rr[1])*sin(theta) + cos(rr[0])*cos(theta)*sin(rr[1])*sin(rr[2])) - cos(cr[1])*cos(rr[0])*cos(rr[1])                                                                                      ; IJ(Dr,9,6,11) = cos(cr[0])*sin(cr[1])*(cos(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2])) - sin(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2]))) - sin(cr[0])*sin(cr[1])*(cos(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2])) + sin(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2])))                                                                             ; IJ(Dr,9,6,12) = cos(cr[0])*sin(cr[1])*(cos(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2])) - sin(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2]))) - sin(cr[0])*sin(cr[1])*(cos(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2])) + sin(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2])))                                                                             ; 
        IJ(Dr,9,7,0) = 0 ; IJ(Dr,9,7,1) = 0 ; IJ(Dr,9,7,2) = 0 ; IJ(Dr,9,7,3) = sin(cr[0])*sin(cr[1])*(cos(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0])) + sin(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2]))) - cos(cr[0])*sin(cr[1])*(cos(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2])) - sin(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0])))                                                                             ; IJ(Dr,9,7,4) = sin(cr[1])*sin(rr[0])*sin(rr[1]) - cos(cr[0])*cos(cr[1])*(cos(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0])) + sin(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2]))) - cos(cr[1])*sin(cr[0])*(cos(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2])) - sin(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0])))                                    ; IJ(Dr,9,7,5) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ; IJ(Dr,9,7,6) = 0 ; IJ(Dr,9,7,7) = 0 ; IJ(Dr,9,7,8) = 0 ; IJ(Dr,9,7,9) = cos(cr[0])*sin(cr[1])*(cos(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2])) + sin(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2]))) + sin(cr[0])*sin(cr[1])*(cos(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2])) - sin(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2]))) - cos(cr[1])*cos(rr[0])*sin(rr[1])                                                                                      ; IJ(Dr,9,7,10) = cos(cr[0])*sin(cr[1])*(cos(rr[2])*cos(theta)*sin(rr[0])*sin(rr[1]) - sin(rr[0])*sin(rr[1])*sin(rr[2])*sin(theta)) - sin(cr[0])*sin(cr[1])*(cos(rr[2])*sin(rr[0])*sin(rr[1])*sin(theta) + cos(theta)*sin(rr[0])*sin(rr[1])*sin(rr[2])) - cos(cr[1])*cos(rr[1])*sin(rr[0])                                                                                      ; IJ(Dr,9,7,11) = sin(cr[0])*sin(cr[1])*(cos(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0])) + sin(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2]))) - cos(cr[0])*sin(cr[1])*(cos(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2])) - sin(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0])))                                                                             ; IJ(Dr,9,7,12) = sin(cr[0])*sin(cr[1])*(cos(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0])) + sin(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2]))) - cos(cr[0])*sin(cr[1])*(cos(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2])) - sin(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0])))                                                                             ; 
        IJ(Dr,9,8,0) = 0 ; IJ(Dr,9,8,1) = 0 ; IJ(Dr,9,8,2) = 0 ; IJ(Dr,9,8,3) = -(sin(cr[0] + rr[2] + theta)*(cos(cr[1] + rr[1]) - cos(cr[1] - rr[1])))/2                                                                                                                                                                                                                                                                                                                                                 ; IJ(Dr,9,8,4) = cos(cr[0])*cos(cr[1])*(sin(rr[1])*sin(rr[2])*sin(theta) - cos(rr[2])*cos(theta)*sin(rr[1])) - cos(rr[1])*sin(cr[1]) + cos(cr[1])*sin(cr[0])*(cos(rr[2])*sin(rr[1])*sin(theta) + cos(theta)*sin(rr[1])*sin(rr[2]))                                                                                                                                                                                                   ; IJ(Dr,9,8,5) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ; IJ(Dr,9,8,6) = 0 ; IJ(Dr,9,8,7) = 0 ; IJ(Dr,9,8,8) = 0 ; IJ(Dr,9,8,9) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ; IJ(Dr,9,8,10) = cos(cr[0])*sin(cr[1])*(cos(rr[1])*sin(rr[2])*sin(theta) - cos(rr[1])*cos(rr[2])*cos(theta)) - cos(cr[1])*sin(rr[1]) + sin(cr[0])*sin(cr[1])*(cos(rr[1])*cos(rr[2])*sin(theta) + cos(rr[1])*cos(theta)*sin(rr[2]))                                                                                                                                             ; IJ(Dr,9,8,11) = -(sin(cr[0] + rr[2] + theta)*(cos(cr[1] + rr[1]) - cos(cr[1] - rr[1])))/2                                                                                                                                                                                                                                                                                                                                                 ; IJ(Dr,9,8,12) = -(sin(cr[0] + rr[2] + theta)*(cos(cr[1] + rr[1]) - cos(cr[1] - rr[1])))/2                                                                                                                                                                                                                                                                                                                                                 ; 

        IJ(Dt,3,0,0) = - cos(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2])) - sin(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2])) ; IJ(Dt,3,0,1) = sin(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2])) - cos(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2])) ; IJ(Dt,3,0,2) = -cos(rr[0])*sin(rr[1]) ; IJ(Dt,3,0,3) = 0 ; IJ(Dt,3,0,4) = 0 ; IJ(Dt,3,0,5) = 0 ; IJ(Dt,3,0,6) = 1 ; IJ(Dt,3,0,7) = 0 ; IJ(Dt,3,0,8) = 0 ; IJ(Dt,3,0,9) = ct[2]*sin(rr[0])*sin(rr[1]) - ct[1]*(cos(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2])) - sin(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0]))) - ct[0]*(cos(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0])) + sin(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2])))   ; IJ(Dt,3,0,10) = cos(rr[0])*(ct[1]*cos(rr[2])*sin(rr[1])*sin(theta) - ct[0]*cos(rr[2])*cos(theta)*sin(rr[1]) - ct[2]*cos(rr[1]) + ct[1]*cos(theta)*sin(rr[1])*sin(rr[2]) + ct[0]*sin(rr[1])*sin(rr[2])*sin(theta)) ; IJ(Dt,3,0,11) = ct[1]*(cos(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2])) + sin(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2]))) - ct[0]*(cos(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2])) - sin(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2]))) ; IJ(Dt,3,0,12) = ct[1]*(cos(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2])) + sin(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2]))) - ct[0]*(cos(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2])) - sin(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2]))) ; 
        IJ(Dt,3,1,0) = cos(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0])) + sin(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2]))   ; IJ(Dt,3,1,1) = cos(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2])) - sin(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0])) ; IJ(Dt,3,1,2) = -sin(rr[0])*sin(rr[1]) ; IJ(Dt,3,1,3) = 0 ; IJ(Dt,3,1,4) = 0 ; IJ(Dt,3,1,5) = 0 ; IJ(Dt,3,1,6) = 0 ; IJ(Dt,3,1,7) = 1 ; IJ(Dt,3,1,8) = 0 ; IJ(Dt,3,1,9) = - ct[0]*(cos(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2])) + sin(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2]))) - ct[1]*(cos(theta)*(cos(rr[2])*sin(rr[0]) + cos(rr[0])*cos(rr[1])*sin(rr[2])) - sin(theta)*(sin(rr[0])*sin(rr[2]) - cos(rr[0])*cos(rr[1])*cos(rr[2]))) - ct[2]*cos(rr[0])*sin(rr[1]) ; IJ(Dt,3,1,10) = sin(rr[0])*(ct[1]*cos(rr[2])*sin(rr[1])*sin(theta) - ct[0]*cos(rr[2])*cos(theta)*sin(rr[1]) - ct[2]*cos(rr[1]) + ct[1]*cos(theta)*sin(rr[1])*sin(rr[2]) + ct[0]*sin(rr[1])*sin(rr[2])*sin(theta)) ; IJ(Dt,3,1,11) = ct[0]*(cos(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2])) - sin(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0]))) - ct[1]*(cos(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0])) + sin(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2]))) ; IJ(Dt,3,1,12) = ct[0]*(cos(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2])) - sin(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0]))) - ct[1]*(cos(theta)*(cos(rr[0])*sin(rr[2]) + cos(rr[1])*cos(rr[2])*sin(rr[0])) + sin(theta)*(cos(rr[0])*cos(rr[2]) - cos(rr[1])*sin(rr[0])*sin(rr[2]))) ; 
        IJ(Dt,3,2,0) = cos(rr[2] + theta)*sin(rr[1])                                                                                                                   ; IJ(Dt,3,2,1) = -sin(rr[2] + theta)*sin(rr[1])                                                                                                                ; IJ(Dt,3,2,2) = cos(rr[1])             ; IJ(Dt,3,2,3) = 0 ; IJ(Dt,3,2,4) = 0 ; IJ(Dt,3,2,5) = 0 ; IJ(Dt,3,2,6) = 0 ; IJ(Dt,3,2,7) = 0 ; IJ(Dt,3,2,8) = 1 ; IJ(Dt,3,2,9) = 0                                                                                                                                                                                                                                                                                                                                             ; IJ(Dt,3,2,10) = - ct[0]*(cos(rr[1])*sin(rr[2])*sin(theta) - cos(rr[1])*cos(rr[2])*cos(theta)) - ct[1]*(cos(rr[1])*cos(rr[2])*sin(theta) + cos(rr[1])*cos(theta)*sin(rr[2])) - ct[2]*sin(rr[1])                    ; IJ(Dt,3,2,11) = -sin(rr[1])*(ct[1]*cos(rr[2] + theta) + ct[0]*sin(rr[2] + theta))                                                                                                                                                                                                                                             ; IJ(Dt,3,2,12) = -sin(rr[1])*(ct[1]*cos(rr[2] + theta) + ct[0]*sin(rr[2] + theta))                                                                                                                                                                                                                                             ; 
    }
}

void mexFunction( int nlhs, mxArray *plhs[],
                  int nrhs, const mxArray *prhs[] )
{
  mxArray *center, *radius;
  double theta;
  size_t m, n, p;
    
  /* Check for proper number of arguments. */
  if(nrhs!=2) {
    mexErrMsgTxt("Two inputs required.");
  } else if(nlhs>3) {
    mexErrMsgTxt("Too many output arguments.");
  }
  
  /* The first input must be a 1x2 cell with two SE(n)'s in it.*/
  if (!mxIsCell(prhs[0]) || mxGetNumberOfDimensions(prhs[0]) != 2 || mxGetM(prhs[0]) != 1 || mxGetN(prhs[0]) != 2) {
      mexErrMsgTxt("params must be a 1x2 cell array.");
  }
  center = mxGetCell(prhs[0], 0);
  m = mxGetM(center);
  n = mxGetN(center);
  if (!mxIsDouble(center) || mxIsComplex(center) || !((m == 3 && n == 3) || (m == 4 && n == 4))) {
      mexErrMsgTxt("params{1} must be a 3x3 or 4x4 real double matrix.");
  }
  radius = mxGetCell(prhs[0], 1);
  p = mxGetM(radius);
  n = mxGetN(radius);
  if (!mxIsDouble(radius) || mxIsComplex(radius) || n != m || p != n) {
      mexErrMsgTxt("params{2} must be a real double matrix with dimension corresponding to params{1}.");
  }

  /* The second input must be a real double scalar. */
  if (!mxIsDouble(prhs[1]) || mxIsComplex(prhs[1]) || mxGetM(prhs[1]) != 1 || mxGetN(prhs[1]) != 1) {
      mexErrMsgTxt("state must be a real double scalar.");
  }
  theta = mxGetPr(prhs[1])[0];
  
  /* Create matrix for the first return argument. */
  plhs[0] = mxCreateDoubleMatrix(m, n, mxREAL);
  if (nlhs == 3) {
      if (m == 3) {
          plhs[1] = mxCreateDoubleMatrix(4, 7, mxREAL);
          plhs[2] = mxCreateDoubleMatrix(2, 7, mxREAL);
      } else {
          plhs[1] = mxCreateDoubleMatrix(9, 13, mxREAL);
          plhs[2] = mxCreateDoubleMatrix(3, 13, mxREAL);
      }
  }
  
  /* Call the subroutine(s). */
  forward_revolute(m-1, mxGetPr(center), mxGetPr(radius), theta, mxGetPr(plhs[0]));
  if (nlhs == 3) {
      mxArray* c_lhs[2];
      mxArray* r_lhs[2];
      
      if (mexCallMATLAB(2, c_lhs, 1, &center, "extract_SE") != 0) {
          mexErrMsgTxt("failed to call extract_SE");
      }
      if (mexCallMATLAB(2, r_lhs, 1, &radius, "extract_SE") != 0) {
          mexErrMsgTxt("failed to call extract_SE");
      }
      
      forward_revolute_gradient(m-1, mxGetPr(c_lhs[0]), mxGetPr(c_lhs[1]), mxGetPr(r_lhs[1]), theta, mxGetPr(plhs[1]), mxGetPr(plhs[2]));
  }
}
