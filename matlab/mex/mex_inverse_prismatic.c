#include <string.h>
#include <math.h>
#include "mex.h"

/*
 * mex_inverse_prismatic.c
 *
 * Translation of inverse_prismatic.m
 *
 * Written by Alex Burka, December 2012
 * University of Pennsylvania, GRASP Lab
 */


/*
% in 2D and 3D
%   params{1} SE(n) is the offset from the from-object center to prismatic joint
%   params{2} R(n)  is the unit vector pointing in the direction of prismaticness
%   state     R     is the extension of the joint
function [state, D] = inverse_prismatic(x, params)
    offset = params{1};
    u = params{2};
    n = length(u);
    
    if n == 3
        state = - (u(1)*(x(1,1)*offset(1,2)*offset(2,3)*offset(3,4) - x(1,1)*offset(1,2)*offset(2,4)*offset(3,3) - x(1,1)*offset(1,3)*offset(2,2)*offset(3,4) + x(1,1)*offset(1,3)*offset(2,4)*offset(3,2) + x(1,1)*offset(1,4)*offset(2,2)*offset(3,3) - x(1,1)*offset(1,4)*offset(2,3)*offset(3,2) - x(1,2)*offset(1,1)*offset(2,3)*offset(3,4) + x(1,2)*offset(1,1)*offset(2,4)*offset(3,3) + x(1,2)*offset(1,3)*offset(2,1)*offset(3,4) - x(1,2)*offset(1,3)*offset(2,4)*offset(3,1) - x(1,2)*offset(1,4)*offset(2,1)*offset(3,3) + x(1,2)*offset(1,4)*offset(2,3)*offset(3,1) + x(1,3)*offset(1,1)*offset(2,2)*offset(3,4) - x(1,3)*offset(1,1)*offset(2,4)*offset(3,2) - x(1,3)*offset(1,2)*offset(2,1)*offset(3,4) + x(1,3)*offset(1,2)*offset(2,4)*offset(3,1) + x(1,3)*offset(1,4)*offset(2,1)*offset(3,2) - x(1,3)*offset(1,4)*offset(2,2)*offset(3,1) - x(1,4)*offset(1,1)*offset(2,2)*offset(3,3) + x(1,4)*offset(1,1)*offset(2,3)*offset(3,2) + x(1,4)*offset(1,2)*offset(2,1)*offset(3,3) - x(1,4)*offset(1,2)*offset(2,3)*offset(3,1) - x(1,4)*offset(1,3)*offset(2,1)*offset(3,2) + x(1,4)*offset(1,3)*offset(2,2)*offset(3,1)))/(offset(1,1)*offset(2,2)*offset(3,3) - offset(1,1)*offset(2,3)*offset(3,2) - offset(1,2)*offset(2,1)*offset(3,3) + offset(1,2)*offset(2,3)*offset(3,1) + offset(1,3)*offset(2,1)*offset(3,2) - offset(1,3)*offset(2,2)*offset(3,1)) - (u(2)*(x(2,1)*offset(1,2)*offset(2,3)*offset(3,4) - x(2,1)*offset(1,2)*offset(2,4)*offset(3,3) - x(2,1)*offset(1,3)*offset(2,2)*offset(3,4) + x(2,1)*offset(1,3)*offset(2,4)*offset(3,2) + x(2,1)*offset(1,4)*offset(2,2)*offset(3,3) - x(2,1)*offset(1,4)*offset(2,3)*offset(3,2) - x(2,2)*offset(1,1)*offset(2,3)*offset(3,4) + x(2,2)*offset(1,1)*offset(2,4)*offset(3,3) + x(2,2)*offset(1,3)*offset(2,1)*offset(3,4) - x(2,2)*offset(1,3)*offset(2,4)*offset(3,1) - x(2,2)*offset(1,4)*offset(2,1)*offset(3,3) + x(2,2)*offset(1,4)*offset(2,3)*offset(3,1) + x(2,3)*offset(1,1)*offset(2,2)*offset(3,4) - x(2,3)*offset(1,1)*offset(2,4)*offset(3,2) - x(2,3)*offset(1,2)*offset(2,1)*offset(3,4) + x(2,3)*offset(1,2)*offset(2,4)*offset(3,1) + x(2,3)*offset(1,4)*offset(2,1)*offset(3,2) - x(2,3)*offset(1,4)*offset(2,2)*offset(3,1) - x(2,4)*offset(1,1)*offset(2,2)*offset(3,3) + x(2,4)*offset(1,1)*offset(2,3)*offset(3,2) + x(2,4)*offset(1,2)*offset(2,1)*offset(3,3) - x(2,4)*offset(1,2)*offset(2,3)*offset(3,1) - x(2,4)*offset(1,3)*offset(2,1)*offset(3,2) + x(2,4)*offset(1,3)*offset(2,2)*offset(3,1)))/(offset(1,1)*offset(2,2)*offset(3,3) - offset(1,1)*offset(2,3)*offset(3,2) - offset(1,2)*offset(2,1)*offset(3,3) + offset(1,2)*offset(2,3)*offset(3,1) + offset(1,3)*offset(2,1)*offset(3,2) - offset(1,3)*offset(2,2)*offset(3,1)) - (u(3)*(x(3,1)*offset(1,2)*offset(2,3)*offset(3,4) - x(3,1)*offset(1,2)*offset(2,4)*offset(3,3) - x(3,1)*offset(1,3)*offset(2,2)*offset(3,4) + x(3,1)*offset(1,3)*offset(2,4)*offset(3,2) + x(3,1)*offset(1,4)*offset(2,2)*offset(3,3) - x(3,1)*offset(1,4)*offset(2,3)*offset(3,2) - x(3,2)*offset(1,1)*offset(2,3)*offset(3,4) + x(3,2)*offset(1,1)*offset(2,4)*offset(3,3) + x(3,2)*offset(1,3)*offset(2,1)*offset(3,4) - x(3,2)*offset(1,3)*offset(2,4)*offset(3,1) - x(3,2)*offset(1,4)*offset(2,1)*offset(3,3) + x(3,2)*offset(1,4)*offset(2,3)*offset(3,1) + x(3,3)*offset(1,1)*offset(2,2)*offset(3,4) - x(3,3)*offset(1,1)*offset(2,4)*offset(3,2) - x(3,3)*offset(1,2)*offset(2,1)*offset(3,4) + x(3,3)*offset(1,2)*offset(2,4)*offset(3,1) + x(3,3)*offset(1,4)*offset(2,1)*offset(3,2) - x(3,3)*offset(1,4)*offset(2,2)*offset(3,1) - x(3,4)*offset(1,1)*offset(2,2)*offset(3,3) + x(3,4)*offset(1,1)*offset(2,3)*offset(3,2) + x(3,4)*offset(1,2)*offset(2,1)*offset(3,3) - x(3,4)*offset(1,2)*offset(2,3)*offset(3,1) - x(3,4)*offset(1,3)*offset(2,1)*offset(3,2) + x(3,4)*offset(1,3)*offset(2,2)*offset(3,1)))/(offset(1,1)*offset(2,2)*offset(3,3) - offset(1,1)*offset(2,3)*offset(3,2) - offset(1,2)*offset(2,1)*offset(3,3) + offset(1,2)*offset(2,3)*offset(3,1) + offset(1,3)*offset(2,1)*offset(3,2) - offset(1,3)*offset(2,2)*offset(3,1));
    else
        state = - u(1)*((x(1,2)*offset(2,3) - x(1,3)*offset(2,2))/offset(2,2) - ((x(1,1)*offset(2,2) - x(1,2)*offset(2,1))*(offset(1,2)*offset(2,3) - offset(1,3)*offset(2,2)))/(offset(2,2)*(offset(1,1)*offset(2,2) - offset(1,2)*offset(2,1)))) - u(2)*((x(2,2)*offset(2,3) - x(2,3)*offset(2,2))/offset(2,2) - ((x(2,1)*offset(2,2) - x(2,2)*offset(2,1))*(offset(1,2)*offset(2,3) - offset(1,3)*offset(2,2)))/(offset(2,2)*(offset(1,1)*offset(2,2) - offset(1,2)*offset(2,1))));
    end
    %state = dot(subsref(x/offset, struct('type','()', 'subs',{{1:d,d+1}})), u);
    
    if nargout > 1
        d = n*(n+1)/2;
        D = vertcat(eye(d+n), zeros([1 d+n]));
        [t, r] = extract_SE(offset);
        if n == 2
            D(end,:) = [ -u(1)*(x(1,1)*cos(r) - x(1,2)*sin(r)) - u(2)*(x(2,1)*cos(r) - x(2,2)*sin(r))
                         -x(1,2)*u(1)*cos(r) - x(2,2)*u(2)*cos(r) - x(1,1)*u(1)*sin(r) - x(2,1)*u(2)*sin(r)
                          x(1,2)*t(1)*u(1)*cos(r) - x(1,1)*t(2)*u(1)*cos(r) + x(2,2)*t(1)*u(2)*cos(r) - x(2,1)*t(2)*u(2)*cos(r) + x(1,1)*t(1)*u(1)*sin(r) + x(1,2)*t(2)*u(1)*sin(r) + x(2,1)*t(1)*u(2)*sin(r) + x(2,2)*t(2)*u(2)*sin(r)
                          x(1,3) - x(1,1)*t(1)*cos(r) - x(1,2)*t(2)*cos(r) + x(1,2)*t(1)*sin(r) - x(1,1)*t(2)*sin(r)
                          x(2,3) - x(2,1)*t(1)*cos(r) - x(2,2)*t(2)*cos(r) + x(2,2)*t(1)*sin(r) - x(2,1)*t(2)*sin(r)                                                                                                                      ];
        else
            D(end,:) = [ x(1,1)*u(1)*sin(r(1))*sin(r(3)) + x(2,1)*u(2)*sin(r(1))*sin(r(3)) + x(3,1)*u(3)*sin(r(1))*sin(r(3)) + x(1,2)*u(1)*cos(r(3))*sin(r(1)) + x(1,3)*u(1)*cos(r(1))*sin(r(2)) + x(2,2)*u(2)*cos(r(3))*sin(r(1)) + x(2,3)*u(2)*cos(r(1))*sin(r(2)) + x(3,2)*u(3)*cos(r(3))*sin(r(1)) + x(3,3)*u(3)*cos(r(1))*sin(r(2)) - x(1,1)*u(1)*cos(r(1))*cos(r(2))*cos(r(3)) - x(2,1)*u(2)*cos(r(1))*cos(r(2))*cos(r(3)) - x(3,1)*u(3)*cos(r(1))*cos(r(2))*cos(r(3)) + x(1,2)*u(1)*cos(r(1))*cos(r(2))*sin(r(3)) + x(2,2)*u(2)*cos(r(1))*cos(r(2))*sin(r(3)) + x(3,2)*u(3)*cos(r(1))*cos(r(2))*sin(r(3))
                         x(1,3)*u(1)*sin(r(1))*sin(r(2)) + x(2,3)*u(2)*sin(r(1))*sin(r(2)) + x(3,3)*u(3)*sin(r(1))*sin(r(2)) - x(1,2)*u(1)*cos(r(1))*cos(r(3)) - x(2,2)*u(2)*cos(r(1))*cos(r(3)) - x(3,2)*u(3)*cos(r(1))*cos(r(3)) - x(1,1)*u(1)*cos(r(1))*sin(r(3)) - x(2,1)*u(2)*cos(r(1))*sin(r(3)) - x(3,1)*u(3)*cos(r(1))*sin(r(3)) - x(1,1)*u(1)*cos(r(2))*cos(r(3))*sin(r(1)) - x(2,1)*u(2)*cos(r(2))*cos(r(3))*sin(r(1)) - x(3,1)*u(3)*cos(r(2))*cos(r(3))*sin(r(1)) + x(1,2)*u(1)*cos(r(2))*sin(r(1))*sin(r(3)) + x(2,2)*u(2)*cos(r(2))*sin(r(1))*sin(r(3)) + x(3,2)*u(3)*cos(r(2))*sin(r(1))*sin(r(3))
                         x(1,2)*u(1)*sin(r(2))*sin(r(3)) - x(2,3)*u(2)*cos(r(2)) - x(3,3)*u(3)*cos(r(2)) - x(1,3)*u(1)*cos(r(2)) + x(2,2)*u(2)*sin(r(2))*sin(r(3)) + x(3,2)*u(3)*sin(r(2))*sin(r(3)) - x(1,1)*u(1)*cos(r(3))*sin(r(2)) - x(2,1)*u(2)*cos(r(3))*sin(r(2)) - x(3,1)*u(3)*cos(r(3))*sin(r(2))
                         x(1,2)*t(1)*u(1)*cos(r(1))*cos(r(3)) + x(2,2)*t(1)*u(2)*cos(r(1))*cos(r(3)) + x(3,2)*t(1)*u(3)*cos(r(1))*cos(r(3)) + x(1,1)*t(1)*u(1)*cos(r(1))*sin(r(3)) + x(1,2)*t(2)*u(1)*cos(r(3))*sin(r(1)) + x(1,3)*t(2)*u(1)*cos(r(1))*sin(r(2)) + x(2,1)*t(1)*u(2)*cos(r(1))*sin(r(3)) + x(2,2)*t(2)*u(2)*cos(r(3))*sin(r(1)) + x(2,3)*t(2)*u(2)*cos(r(1))*sin(r(2)) + x(3,1)*t(1)*u(3)*cos(r(1))*sin(r(3)) + x(3,2)*t(2)*u(3)*cos(r(3))*sin(r(1)) + x(3,3)*t(2)*u(3)*cos(r(1))*sin(r(2)) - x(1,3)*t(1)*u(1)*sin(r(1))*sin(r(2)) + x(1,1)*t(2)*u(1)*sin(r(1))*sin(r(3)) - x(2,3)*t(1)*u(2)*sin(r(1))*sin(r(2)) + x(2,1)*t(2)*u(2)*sin(r(1))*sin(r(3)) - x(3,3)*t(1)*u(3)*sin(r(1))*sin(r(2)) + x(3,1)*t(2)*u(3)*sin(r(1))*sin(r(3)) - x(1,1)*t(2)*u(1)*cos(r(1))*cos(r(2))*cos(r(3)) - x(2,1)*t(2)*u(2)*cos(r(1))*cos(r(2))*cos(r(3)) - x(3,1)*t(2)*u(3)*cos(r(1))*cos(r(2))*cos(r(3)) + x(1,1)*t(1)*u(1)*cos(r(2))*cos(r(3))*sin(r(1)) + x(1,2)*t(2)*u(1)*cos(r(1))*cos(r(2))*sin(r(3)) + x(2,1)*t(1)*u(2)*cos(r(2))*cos(r(3))*sin(r(1)) + x(2,2)*t(2)*u(2)*cos(r(1))*cos(r(2))*sin(r(3)) + x(3,1)*t(1)*u(3)*cos(r(2))*cos(r(3))*sin(r(1)) + x(3,2)*t(2)*u(3)*cos(r(1))*cos(r(2))*sin(r(3)) - x(1,2)*t(1)*u(1)*cos(r(2))*sin(r(1))*sin(r(3)) - x(2,2)*t(1)*u(2)*cos(r(2))*sin(r(1))*sin(r(3)) - x(3,2)*t(1)*u(3)*cos(r(2))*sin(r(1))*sin(r(3))
                         x(1,3)*t(3)*u(1)*sin(r(2)) + x(2,3)*t(3)*u(2)*sin(r(2)) + x(3,3)*t(3)*u(3)*sin(r(2)) + x(1,3)*t(1)*u(1)*cos(r(1))*cos(r(2)) - x(1,1)*t(3)*u(1)*cos(r(2))*cos(r(3)) + x(2,3)*t(1)*u(2)*cos(r(1))*cos(r(2)) - x(2,1)*t(3)*u(2)*cos(r(2))*cos(r(3)) + x(3,3)*t(1)*u(3)*cos(r(1))*cos(r(2)) - x(3,1)*t(3)*u(3)*cos(r(2))*cos(r(3)) + x(1,3)*t(2)*u(1)*cos(r(2))*sin(r(1)) + x(1,2)*t(3)*u(1)*cos(r(2))*sin(r(3)) + x(2,3)*t(2)*u(2)*cos(r(2))*sin(r(1)) + x(2,2)*t(3)*u(2)*cos(r(2))*sin(r(3)) + x(3,3)*t(2)*u(3)*cos(r(2))*sin(r(1)) + x(3,2)*t(3)*u(3)*cos(r(2))*sin(r(3)) + x(1,1)*t(1)*u(1)*cos(r(1))*cos(r(3))*sin(r(2)) + x(2,1)*t(1)*u(2)*cos(r(1))*cos(r(3))*sin(r(2)) + x(3,1)*t(1)*u(3)*cos(r(1))*cos(r(3))*sin(r(2)) - x(1,2)*t(1)*u(1)*cos(r(1))*sin(r(2))*sin(r(3)) + x(1,1)*t(2)*u(1)*cos(r(3))*sin(r(1))*sin(r(2)) - x(2,2)*t(1)*u(2)*cos(r(1))*sin(r(2))*sin(r(3)) + x(2,1)*t(2)*u(2)*cos(r(3))*sin(r(1))*sin(r(2)) - x(3,2)*t(1)*u(3)*cos(r(1))*sin(r(2))*sin(r(3)) + x(3,1)*t(2)*u(3)*cos(r(3))*sin(r(1))*sin(r(2)) - x(1,2)*t(2)*u(1)*sin(r(1))*sin(r(2))*sin(r(3)) - x(2,2)*t(2)*u(2)*sin(r(1))*sin(r(2))*sin(r(3)) - x(3,2)*t(2)*u(3)*sin(r(1))*sin(r(2))*sin(r(3))
                         x(1,1)*t(1)*u(1)*cos(r(3))*sin(r(1)) - x(2,1)*t(2)*u(2)*cos(r(1))*cos(r(3)) - x(3,1)*t(2)*u(3)*cos(r(1))*cos(r(3)) - x(1,1)*t(2)*u(1)*cos(r(1))*cos(r(3)) + x(1,2)*t(2)*u(1)*cos(r(1))*sin(r(3)) + x(2,1)*t(1)*u(2)*cos(r(3))*sin(r(1)) + x(1,2)*t(3)*u(1)*cos(r(3))*sin(r(2)) + x(2,2)*t(2)*u(2)*cos(r(1))*sin(r(3)) + x(3,1)*t(1)*u(3)*cos(r(3))*sin(r(1)) + x(2,2)*t(3)*u(2)*cos(r(3))*sin(r(2)) + x(3,2)*t(2)*u(3)*cos(r(1))*sin(r(3)) + x(3,2)*t(3)*u(3)*cos(r(3))*sin(r(2)) - x(1,2)*t(1)*u(1)*sin(r(1))*sin(r(3)) + x(1,1)*t(3)*u(1)*sin(r(2))*sin(r(3)) - x(2,2)*t(1)*u(2)*sin(r(1))*sin(r(3)) + x(2,1)*t(3)*u(2)*sin(r(2))*sin(r(3)) - x(3,2)*t(1)*u(3)*sin(r(1))*sin(r(3)) + x(3,1)*t(3)*u(3)*sin(r(2))*sin(r(3)) + x(1,2)*t(1)*u(1)*cos(r(1))*cos(r(2))*cos(r(3)) + x(2,2)*t(1)*u(2)*cos(r(1))*cos(r(2))*cos(r(3)) + x(3,2)*t(1)*u(3)*cos(r(1))*cos(r(2))*cos(r(3)) + x(1,1)*t(1)*u(1)*cos(r(1))*cos(r(2))*sin(r(3)) + x(1,2)*t(2)*u(1)*cos(r(2))*cos(r(3))*sin(r(1)) + x(2,1)*t(1)*u(2)*cos(r(1))*cos(r(2))*sin(r(3)) + x(2,2)*t(2)*u(2)*cos(r(2))*cos(r(3))*sin(r(1)) + x(3,1)*t(1)*u(3)*cos(r(1))*cos(r(2))*sin(r(3)) + x(3,2)*t(2)*u(3)*cos(r(2))*cos(r(3))*sin(r(1)) + x(1,1)*t(2)*u(1)*cos(r(2))*sin(r(1))*sin(r(3)) + x(2,1)*t(2)*u(2)*cos(r(2))*sin(r(1))*sin(r(3)) + x(3,1)*t(2)*u(3)*cos(r(2))*sin(r(1))*sin(r(3))
                         x(1,4) - x(1,3)*t(3)*cos(r(2)) + x(1,1)*t(1)*sin(r(1))*sin(r(3)) + x(1,3)*t(2)*sin(r(1))*sin(r(2)) + x(1,2)*t(3)*sin(r(2))*sin(r(3)) - x(1,2)*t(2)*cos(r(1))*cos(r(3)) + x(1,2)*t(1)*cos(r(3))*sin(r(1)) + x(1,3)*t(1)*cos(r(1))*sin(r(2)) - x(1,1)*t(2)*cos(r(1))*sin(r(3)) - x(1,1)*t(3)*cos(r(3))*sin(r(2)) - x(1,1)*t(1)*cos(r(1))*cos(r(2))*cos(r(3)) + x(1,2)*t(1)*cos(r(1))*cos(r(2))*sin(r(3)) - x(1,1)*t(2)*cos(r(2))*cos(r(3))*sin(r(1)) + x(1,2)*t(2)*cos(r(2))*sin(r(1))*sin(r(3))
                         x(2,4) - x(2,3)*t(3)*cos(r(2)) + x(2,1)*t(1)*sin(r(1))*sin(r(3)) + x(2,3)*t(2)*sin(r(1))*sin(r(2)) + x(2,2)*t(3)*sin(r(2))*sin(r(3)) - x(2,2)*t(2)*cos(r(1))*cos(r(3)) + x(2,2)*t(1)*cos(r(3))*sin(r(1)) + x(2,3)*t(1)*cos(r(1))*sin(r(2)) - x(2,1)*t(2)*cos(r(1))*sin(r(3)) - x(2,1)*t(3)*cos(r(3))*sin(r(2)) - x(2,1)*t(1)*cos(r(1))*cos(r(2))*cos(r(3)) + x(2,2)*t(1)*cos(r(1))*cos(r(2))*sin(r(3)) - x(2,1)*t(2)*cos(r(2))*cos(r(3))*sin(r(1)) + x(2,2)*t(2)*cos(r(2))*sin(r(1))*sin(r(3))
                         x(3,4) - x(3,3)*t(3)*cos(r(2)) + x(3,1)*t(1)*sin(r(1))*sin(r(3)) + x(3,3)*t(2)*sin(r(1))*sin(r(2)) + x(3,2)*t(3)*sin(r(2))*sin(r(3)) - x(3,2)*t(2)*cos(r(1))*cos(r(3)) + x(3,2)*t(1)*cos(r(3))*sin(r(1)) + x(3,3)*t(1)*cos(r(1))*sin(r(2)) - x(3,1)*t(2)*cos(r(1))*sin(r(3)) - x(3,1)*t(3)*cos(r(3))*sin(r(2)) - x(3,1)*t(1)*cos(r(1))*cos(r(2))*cos(r(3)) + x(3,2)*t(1)*cos(r(1))*cos(r(2))*sin(r(3)) - x(3,1)*t(2)*cos(r(2))*cos(r(3))*sin(r(1)) + x(3,2)*t(2)*cos(r(2))*sin(r(1))*sin(r(3))                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ];

        end
    end
end
*/

#define IJ(m,n,i,j) ((m)[(i) + (n)*(j)])

void inverse_prismatic(int n, double *x, double *offset, double *u, double *pos)
{
    if (n == 2) {
        *pos = - u[0]*((IJ(x,3,0,1)*IJ(offset,3,1,2) - IJ(x,3,0,2)*IJ(offset,3,1,1))/IJ(offset,3,1,1) - ((IJ(x,3,0,0)*IJ(offset,3,1,1) - IJ(x,3,0,1)*IJ(offset,3,1,0))*(IJ(offset,3,0,1)*IJ(offset,3,1,2) - IJ(offset,3,0,2)*IJ(offset,3,1,1)))/(IJ(offset,3,1,1)*(IJ(offset,3,0,0)*IJ(offset,3,1,1) - IJ(offset,3,0,1)*IJ(offset,3,1,0)))) - u[1]*((IJ(x,3,1,1)*IJ(offset,3,1,2) - IJ(x,3,1,2)*IJ(offset,3,1,1))/IJ(offset,3,1,1) - ((IJ(x,3,1,0)*IJ(offset,3,1,1) - IJ(x,3,1,1)*IJ(offset,3,1,0))*(IJ(offset,3,0,1)*IJ(offset,3,1,2) - IJ(offset,3,0,2)*IJ(offset,3,1,1)))/(IJ(offset,3,1,1)*(IJ(offset,3,0,0)*IJ(offset,3,1,1) - IJ(offset,3,0,1)*IJ(offset,3,1,0))));
    } else {
        *pos = - (u[0]*(IJ(x,4,0,0)*IJ(offset,4,0,1)*IJ(offset,4,1,2)*IJ(offset,4,2,3) - IJ(x,4,0,0)*IJ(offset,4,0,1)*IJ(offset,4,1,3)*IJ(offset,4,2,2) - IJ(x,4,0,0)*IJ(offset,4,0,2)*IJ(offset,4,1,1)*IJ(offset,4,2,3) + IJ(x,4,0,0)*IJ(offset,4,0,2)*IJ(offset,4,1,3)*IJ(offset,4,2,1) + IJ(x,4,0,0)*IJ(offset,4,0,3)*IJ(offset,4,1,1)*IJ(offset,4,2,2) - IJ(x,4,0,0)*IJ(offset,4,0,3)*IJ(offset,4,1,2)*IJ(offset,4,2,1) - IJ(x,4,0,1)*IJ(offset,4,0,0)*IJ(offset,4,1,2)*IJ(offset,4,2,3) + IJ(x,4,0,1)*IJ(offset,4,0,0)*IJ(offset,4,1,3)*IJ(offset,4,2,2) + IJ(x,4,0,1)*IJ(offset,4,0,2)*IJ(offset,4,1,0)*IJ(offset,4,2,3) - IJ(x,4,0,1)*IJ(offset,4,0,2)*IJ(offset,4,1,3)*IJ(offset,4,2,0) - IJ(x,4,0,1)*IJ(offset,4,0,3)*IJ(offset,4,1,0)*IJ(offset,4,2,2) + IJ(x,4,0,1)*IJ(offset,4,0,3)*IJ(offset,4,1,2)*IJ(offset,4,2,0) + IJ(x,4,0,2)*IJ(offset,4,0,0)*IJ(offset,4,1,1)*IJ(offset,4,2,3) - IJ(x,4,0,2)*IJ(offset,4,0,0)*IJ(offset,4,1,3)*IJ(offset,4,2,1) - IJ(x,4,0,2)*IJ(offset,4,0,1)*IJ(offset,4,1,0)*IJ(offset,4,2,3) + IJ(x,4,0,2)*IJ(offset,4,0,1)*IJ(offset,4,1,3)*IJ(offset,4,2,0) + IJ(x,4,0,2)*IJ(offset,4,0,3)*IJ(offset,4,1,0)*IJ(offset,4,2,1) - IJ(x,4,0,2)*IJ(offset,4,0,3)*IJ(offset,4,1,1)*IJ(offset,4,2,0) - IJ(x,4,0,3)*IJ(offset,4,0,0)*IJ(offset,4,1,1)*IJ(offset,4,2,2) + IJ(x,4,0,3)*IJ(offset,4,0,0)*IJ(offset,4,1,2)*IJ(offset,4,2,1) + IJ(x,4,0,3)*IJ(offset,4,0,1)*IJ(offset,4,1,0)*IJ(offset,4,2,2) - IJ(x,4,0,3)*IJ(offset,4,0,1)*IJ(offset,4,1,2)*IJ(offset,4,2,0) - IJ(x,4,0,3)*IJ(offset,4,0,2)*IJ(offset,4,1,0)*IJ(offset,4,2,1) + IJ(x,4,0,3)*IJ(offset,4,0,2)*IJ(offset,4,1,1)*IJ(offset,4,2,0)))/(IJ(offset,4,0,0)*IJ(offset,4,1,1)*IJ(offset,4,2,2) - IJ(offset,4,0,0)*IJ(offset,4,1,2)*IJ(offset,4,2,1) - IJ(offset,4,0,1)*IJ(offset,4,1,0)*IJ(offset,4,2,2) + IJ(offset,4,0,1)*IJ(offset,4,1,2)*IJ(offset,4,2,0) + IJ(offset,4,0,2)*IJ(offset,4,1,0)*IJ(offset,4,2,1) - IJ(offset,4,0,2)*IJ(offset,4,1,1)*IJ(offset,4,2,0)) - (u[1]*(IJ(x,4,1,0)*IJ(offset,4,0,1)*IJ(offset,4,1,2)*IJ(offset,4,2,3) - IJ(x,4,1,0)*IJ(offset,4,0,1)*IJ(offset,4,1,3)*IJ(offset,4,2,2) - IJ(x,4,1,0)*IJ(offset,4,0,2)*IJ(offset,4,1,1)*IJ(offset,4,2,3) + IJ(x,4,1,0)*IJ(offset,4,0,2)*IJ(offset,4,1,3)*IJ(offset,4,2,1) + IJ(x,4,1,0)*IJ(offset,4,0,3)*IJ(offset,4,1,1)*IJ(offset,4,2,2) - IJ(x,4,1,0)*IJ(offset,4,0,3)*IJ(offset,4,1,2)*IJ(offset,4,2,1) - IJ(x,4,1,1)*IJ(offset,4,0,0)*IJ(offset,4,1,2)*IJ(offset,4,2,3) + IJ(x,4,1,1)*IJ(offset,4,0,0)*IJ(offset,4,1,3)*IJ(offset,4,2,2) + IJ(x,4,1,1)*IJ(offset,4,0,2)*IJ(offset,4,1,0)*IJ(offset,4,2,3) - IJ(x,4,1,1)*IJ(offset,4,0,2)*IJ(offset,4,1,3)*IJ(offset,4,2,0) - IJ(x,4,1,1)*IJ(offset,4,0,3)*IJ(offset,4,1,0)*IJ(offset,4,2,2) + IJ(x,4,1,1)*IJ(offset,4,0,3)*IJ(offset,4,1,2)*IJ(offset,4,2,0) + IJ(x,4,1,2)*IJ(offset,4,0,0)*IJ(offset,4,1,1)*IJ(offset,4,2,3) - IJ(x,4,1,2)*IJ(offset,4,0,0)*IJ(offset,4,1,3)*IJ(offset,4,2,1) - IJ(x,4,1,2)*IJ(offset,4,0,1)*IJ(offset,4,1,0)*IJ(offset,4,2,3) + IJ(x,4,1,2)*IJ(offset,4,0,1)*IJ(offset,4,1,3)*IJ(offset,4,2,0) + IJ(x,4,1,2)*IJ(offset,4,0,3)*IJ(offset,4,1,0)*IJ(offset,4,2,1) - IJ(x,4,1,2)*IJ(offset,4,0,3)*IJ(offset,4,1,1)*IJ(offset,4,2,0) - IJ(x,4,1,3)*IJ(offset,4,0,0)*IJ(offset,4,1,1)*IJ(offset,4,2,2) + IJ(x,4,1,3)*IJ(offset,4,0,0)*IJ(offset,4,1,2)*IJ(offset,4,2,1) + IJ(x,4,1,3)*IJ(offset,4,0,1)*IJ(offset,4,1,0)*IJ(offset,4,2,2) - IJ(x,4,1,3)*IJ(offset,4,0,1)*IJ(offset,4,1,2)*IJ(offset,4,2,0) - IJ(x,4,1,3)*IJ(offset,4,0,2)*IJ(offset,4,1,0)*IJ(offset,4,2,1) + IJ(x,4,1,3)*IJ(offset,4,0,2)*IJ(offset,4,1,1)*IJ(offset,4,2,0)))/(IJ(offset,4,0,0)*IJ(offset,4,1,1)*IJ(offset,4,2,2) - IJ(offset,4,0,0)*IJ(offset,4,1,2)*IJ(offset,4,2,1) - IJ(offset,4,0,1)*IJ(offset,4,1,0)*IJ(offset,4,2,2) + IJ(offset,4,0,1)*IJ(offset,4,1,2)*IJ(offset,4,2,0) + IJ(offset,4,0,2)*IJ(offset,4,1,0)*IJ(offset,4,2,1) - IJ(offset,4,0,2)*IJ(offset,4,1,1)*IJ(offset,4,2,0)) - (u[2]*(IJ(x,4,2,0)*IJ(offset,4,0,1)*IJ(offset,4,1,2)*IJ(offset,4,2,3) - IJ(x,4,2,0)*IJ(offset,4,0,1)*IJ(offset,4,1,3)*IJ(offset,4,2,2) - IJ(x,4,2,0)*IJ(offset,4,0,2)*IJ(offset,4,1,1)*IJ(offset,4,2,3) + IJ(x,4,2,0)*IJ(offset,4,0,2)*IJ(offset,4,1,3)*IJ(offset,4,2,1) + IJ(x,4,2,0)*IJ(offset,4,0,3)*IJ(offset,4,1,1)*IJ(offset,4,2,2) - IJ(x,4,2,0)*IJ(offset,4,0,3)*IJ(offset,4,1,2)*IJ(offset,4,2,1) - IJ(x,4,2,1)*IJ(offset,4,0,0)*IJ(offset,4,1,2)*IJ(offset,4,2,3) + IJ(x,4,2,1)*IJ(offset,4,0,0)*IJ(offset,4,1,3)*IJ(offset,4,2,2) + IJ(x,4,2,1)*IJ(offset,4,0,2)*IJ(offset,4,1,0)*IJ(offset,4,2,3) - IJ(x,4,2,1)*IJ(offset,4,0,2)*IJ(offset,4,1,3)*IJ(offset,4,2,0) - IJ(x,4,2,1)*IJ(offset,4,0,3)*IJ(offset,4,1,0)*IJ(offset,4,2,2) + IJ(x,4,2,1)*IJ(offset,4,0,3)*IJ(offset,4,1,2)*IJ(offset,4,2,0) + IJ(x,4,2,2)*IJ(offset,4,0,0)*IJ(offset,4,1,1)*IJ(offset,4,2,3) - IJ(x,4,2,2)*IJ(offset,4,0,0)*IJ(offset,4,1,3)*IJ(offset,4,2,1) - IJ(x,4,2,2)*IJ(offset,4,0,1)*IJ(offset,4,1,0)*IJ(offset,4,2,3) + IJ(x,4,2,2)*IJ(offset,4,0,1)*IJ(offset,4,1,3)*IJ(offset,4,2,0) + IJ(x,4,2,2)*IJ(offset,4,0,3)*IJ(offset,4,1,0)*IJ(offset,4,2,1) - IJ(x,4,2,2)*IJ(offset,4,0,3)*IJ(offset,4,1,1)*IJ(offset,4,2,0) - IJ(x,4,2,3)*IJ(offset,4,0,0)*IJ(offset,4,1,1)*IJ(offset,4,2,2) + IJ(x,4,2,3)*IJ(offset,4,0,0)*IJ(offset,4,1,2)*IJ(offset,4,2,1) + IJ(x,4,2,3)*IJ(offset,4,0,1)*IJ(offset,4,1,0)*IJ(offset,4,2,2) - IJ(x,4,2,3)*IJ(offset,4,0,1)*IJ(offset,4,1,2)*IJ(offset,4,2,0) - IJ(x,4,2,3)*IJ(offset,4,0,2)*IJ(offset,4,1,0)*IJ(offset,4,2,1) + IJ(x,4,2,3)*IJ(offset,4,0,2)*IJ(offset,4,1,1)*IJ(offset,4,2,0)))/(IJ(offset,4,0,0)*IJ(offset,4,1,1)*IJ(offset,4,2,2) - IJ(offset,4,0,0)*IJ(offset,4,1,2)*IJ(offset,4,2,1) - IJ(offset,4,0,1)*IJ(offset,4,1,0)*IJ(offset,4,2,2) + IJ(offset,4,0,1)*IJ(offset,4,1,2)*IJ(offset,4,2,0) + IJ(offset,4,0,2)*IJ(offset,4,1,0)*IJ(offset,4,2,1) - IJ(offset,4,0,2)*IJ(offset,4,1,1)*IJ(offset,4,2,0));
    }
}

void inverse_prismatic_gradient(int n, double *x, double *u, double *t, double *r, double *D)
{
    if (n == 2) {
        IJ(D,6,0,0) = 1                                                                                                             ; IJ(D,6,0,1) = 0                                                                                                                   ; IJ(D,6,0,2) = 0                                                                                                                                                                                                                                                                             ; IJ(D,6,0,3) = 0                                                                                                                               ; IJ(D,6,0,4) = 0                                                                                                                               ; 
        IJ(D,6,1,0) = 0                                                                                                             ; IJ(D,6,1,1) = 1                                                                                                                   ; IJ(D,6,1,2) = 0                                                                                                                                                                                                                                                                             ; IJ(D,6,1,3) = 0                                                                                                                               ; IJ(D,6,1,4) = 0                                                                                                                               ; 
        IJ(D,6,2,0) = 0                                                                                                             ; IJ(D,6,2,1) = 0                                                                                                                   ; IJ(D,6,2,2) = 1                                                                                                                                                                                                                                                                             ; IJ(D,6,2,3) = 0                                                                                                                               ; IJ(D,6,2,4) = 0                                                                                                                               ; 
        IJ(D,6,3,0) = 0                                                                                                             ; IJ(D,6,3,1) = 0                                                                                                                   ; IJ(D,6,3,2) = 0                                                                                                                                                                                                                                                                             ; IJ(D,6,3,3) = 1                                                                                                                               ; IJ(D,6,3,4) = 0                                                                                                                               ; 
        IJ(D,6,4,0) = 0                                                                                                             ; IJ(D,6,4,1) = 0                                                                                                                   ; IJ(D,6,4,2) = 0                                                                                                                                                                                                                                                                             ; IJ(D,6,4,3) = 0                                                                                                                               ; IJ(D,6,4,4) = 1                                                                                                                               ; 
        IJ(D,6,5,0) = - u[0]*(IJ(x,3,0,0)*cos(r[0]) - IJ(x,3,0,1)*sin(r[0])) - u[1]*(IJ(x,3,1,0)*cos(r[0]) - IJ(x,3,1,1)*sin(r[0])) ; IJ(D,6,5,1) = - u[0]*IJ(x,3,0,1)*cos(r[0]) - u[1]*IJ(x,3,1,1)*cos(r[0]) - u[0]*IJ(x,3,0,0)*sin(r[0]) - u[1]*IJ(x,3,1,0)*sin(r[0]) ; IJ(D,6,5,2) = t[0]*u[0]*IJ(x,3,0,1)*cos(r[0]) - t[1]*u[0]*IJ(x,3,0,0)*cos(r[0]) + t[0]*u[1]*IJ(x,3,1,1)*cos(r[0]) - t[1]*u[1]*IJ(x,3,1,0)*cos(r[0]) + t[0]*u[0]*IJ(x,3,0,0)*sin(r[0]) + t[1]*u[0]*IJ(x,3,0,1)*sin(r[0]) + t[0]*u[1]*IJ(x,3,1,0)*sin(r[0]) + t[1]*u[1]*IJ(x,3,1,1)*sin(r[0]) ; IJ(D,6,5,3) = IJ(x,3,0,2) - t[0]*IJ(x,3,0,0)*cos(r[0]) - t[1]*IJ(x,3,0,1)*cos(r[0]) + t[0]*IJ(x,3,0,1)*sin(r[0]) - t[1]*IJ(x,3,0,0)*sin(r[0]) ; IJ(D,6,5,4) = IJ(x,3,1,2) - t[0]*IJ(x,3,1,0)*cos(r[0]) - t[1]*IJ(x,3,1,1)*cos(r[0]) + t[0]*IJ(x,3,1,1)*sin(r[0]) - t[1]*IJ(x,3,1,0)*sin(r[0]) ; 
    } else {
        IJ(D,10,0,0) = 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ; IJ(D,10,0,1) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ; IJ(D,10,0,2) = 0                                                                                                                                                                                                                                                                                                                              ; IJ(D,10,0,3) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ; IJ(D,10,0,4) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ; IJ(D,10,0,5) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ; IJ(D,10,0,6) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ; IJ(D,10,0,7) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ; IJ(D,10,0,8) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ; 
        IJ(D,10,1,0) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ; IJ(D,10,1,1) = 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ; IJ(D,10,1,2) = 0                                                                                                                                                                                                                                                                                                                              ; IJ(D,10,1,3) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ; IJ(D,10,1,4) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ; IJ(D,10,1,5) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ; IJ(D,10,1,6) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ; IJ(D,10,1,7) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ; IJ(D,10,1,8) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ; 
        IJ(D,10,2,0) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ; IJ(D,10,2,1) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ; IJ(D,10,2,2) = 1                                                                                                                                                                                                                                                                                                                              ; IJ(D,10,2,3) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ; IJ(D,10,2,4) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ; IJ(D,10,2,5) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ; IJ(D,10,2,6) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ; IJ(D,10,2,7) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ; IJ(D,10,2,8) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ; 
        IJ(D,10,3,0) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ; IJ(D,10,3,1) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ; IJ(D,10,3,2) = 0                                                                                                                                                                                                                                                                                                                              ; IJ(D,10,3,3) = 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ; IJ(D,10,3,4) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ; IJ(D,10,3,5) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ; IJ(D,10,3,6) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ; IJ(D,10,3,7) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ; IJ(D,10,3,8) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ; 
        IJ(D,10,4,0) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ; IJ(D,10,4,1) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ; IJ(D,10,4,2) = 0                                                                                                                                                                                                                                                                                                                              ; IJ(D,10,4,3) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ; IJ(D,10,4,4) = 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ; IJ(D,10,4,5) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ; IJ(D,10,4,6) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ; IJ(D,10,4,7) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ; IJ(D,10,4,8) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ; 
        IJ(D,10,5,0) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ; IJ(D,10,5,1) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ; IJ(D,10,5,2) = 0                                                                                                                                                                                                                                                                                                                              ; IJ(D,10,5,3) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ; IJ(D,10,5,4) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ; IJ(D,10,5,5) = 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ; IJ(D,10,5,6) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ; IJ(D,10,5,7) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ; IJ(D,10,5,8) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ; 
        IJ(D,10,6,0) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ; IJ(D,10,6,1) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ; IJ(D,10,6,2) = 0                                                                                                                                                                                                                                                                                                                              ; IJ(D,10,6,3) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ; IJ(D,10,6,4) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ; IJ(D,10,6,5) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ; IJ(D,10,6,6) = 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ; IJ(D,10,6,7) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ; IJ(D,10,6,8) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ; 
        IJ(D,10,7,0) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ; IJ(D,10,7,1) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ; IJ(D,10,7,2) = 0                                                                                                                                                                                                                                                                                                                              ; IJ(D,10,7,3) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ; IJ(D,10,7,4) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ; IJ(D,10,7,5) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ; IJ(D,10,7,6) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ; IJ(D,10,7,7) = 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ; IJ(D,10,7,8) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ; 
        IJ(D,10,8,0) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ; IJ(D,10,8,1) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ; IJ(D,10,8,2) = 0                                                                                                                                                                                                                                                                                                                              ; IJ(D,10,8,3) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ; IJ(D,10,8,4) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ; IJ(D,10,8,5) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ; IJ(D,10,8,6) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ; IJ(D,10,8,7) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ; IJ(D,10,8,8) = 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ; 
        IJ(D,10,9,0) = u[0]*IJ(x,4,0,2)*cos(r[0])*sin(r[1]) + u[0]*IJ(x,4,0,1)*cos(r[2])*sin(r[0]) + u[1]*IJ(x,4,1,2)*cos(r[0])*sin(r[1]) + u[1]*IJ(x,4,1,1)*cos(r[2])*sin(r[0]) + u[2]*IJ(x,4,2,2)*cos(r[0])*sin(r[1]) + u[2]*IJ(x,4,2,1)*cos(r[2])*sin(r[0]) + u[0]*IJ(x,4,0,0)*sin(r[0])*sin(r[2]) + u[1]*IJ(x,4,1,0)*sin(r[0])*sin(r[2]) + u[2]*IJ(x,4,2,0)*sin(r[0])*sin(r[2]) - u[0]*IJ(x,4,0,0)*cos(r[0])*cos(r[1])*cos(r[2]) - u[1]*IJ(x,4,1,0)*cos(r[0])*cos(r[1])*cos(r[2]) - u[2]*IJ(x,4,2,0)*cos(r[0])*cos(r[1])*cos(r[2]) + u[0]*IJ(x,4,0,1)*cos(r[0])*cos(r[1])*sin(r[2]) + u[1]*IJ(x,4,1,1)*cos(r[0])*cos(r[1])*sin(r[2]) + u[2]*IJ(x,4,2,1)*cos(r[0])*cos(r[1])*sin(r[2]) ; IJ(D,10,9,1) = u[0]*IJ(x,4,0,2)*sin(r[0])*sin(r[1]) - u[1]*IJ(x,4,1,0)*cos(r[0])*sin(r[2]) - u[2]*IJ(x,4,2,0)*cos(r[0])*sin(r[2]) - u[0]*IJ(x,4,0,0)*cos(r[0])*sin(r[2]) + u[1]*IJ(x,4,1,2)*sin(r[0])*sin(r[1]) + u[2]*IJ(x,4,2,2)*sin(r[0])*sin(r[1]) - u[0]*IJ(x,4,0,1)*cos(r[0])*cos(r[2]) - u[1]*IJ(x,4,1,1)*cos(r[0])*cos(r[2]) - u[2]*IJ(x,4,2,1)*cos(r[0])*cos(r[2]) - u[0]*IJ(x,4,0,0)*cos(r[1])*cos(r[2])*sin(r[0]) - u[1]*IJ(x,4,1,0)*cos(r[1])*cos(r[2])*sin(r[0]) - u[2]*IJ(x,4,2,0)*cos(r[1])*cos(r[2])*sin(r[0]) + u[0]*IJ(x,4,0,1)*cos(r[1])*sin(r[0])*sin(r[2]) + u[1]*IJ(x,4,1,1)*cos(r[1])*sin(r[0])*sin(r[2]) + u[2]*IJ(x,4,2,1)*cos(r[1])*sin(r[0])*sin(r[2]) ; IJ(D,10,9,2) = u[0]*IJ(x,4,0,1)*sin(r[1])*sin(r[2]) - u[1]*IJ(x,4,1,2)*cos(r[1]) - u[2]*IJ(x,4,2,2)*cos(r[1]) - u[0]*IJ(x,4,0,0)*cos(r[2])*sin(r[1]) - u[1]*IJ(x,4,1,0)*cos(r[2])*sin(r[1]) - u[2]*IJ(x,4,2,0)*cos(r[2])*sin(r[1]) - u[0]*IJ(x,4,0,2)*cos(r[1]) + u[1]*IJ(x,4,1,1)*sin(r[1])*sin(r[2]) + u[2]*IJ(x,4,2,1)*sin(r[1])*sin(r[2]) ; IJ(D,10,9,3) = t[0]*u[0]*IJ(x,4,0,1)*cos(r[0])*cos(r[2]) + t[0]*u[1]*IJ(x,4,1,1)*cos(r[0])*cos(r[2]) + t[0]*u[2]*IJ(x,4,2,1)*cos(r[0])*cos(r[2]) + t[0]*u[0]*IJ(x,4,0,0)*cos(r[0])*sin(r[2]) + t[1]*u[0]*IJ(x,4,0,2)*cos(r[0])*sin(r[1]) + t[1]*u[0]*IJ(x,4,0,1)*cos(r[2])*sin(r[0]) + t[0]*u[1]*IJ(x,4,1,0)*cos(r[0])*sin(r[2]) + t[1]*u[1]*IJ(x,4,1,2)*cos(r[0])*sin(r[1]) + t[1]*u[1]*IJ(x,4,1,1)*cos(r[2])*sin(r[0]) + t[0]*u[2]*IJ(x,4,2,0)*cos(r[0])*sin(r[2]) + t[1]*u[2]*IJ(x,4,2,2)*cos(r[0])*sin(r[1]) + t[1]*u[2]*IJ(x,4,2,1)*cos(r[2])*sin(r[0]) - t[0]*u[0]*IJ(x,4,0,2)*sin(r[0])*sin(r[1]) + t[1]*u[0]*IJ(x,4,0,0)*sin(r[0])*sin(r[2]) - t[0]*u[1]*IJ(x,4,1,2)*sin(r[0])*sin(r[1]) + t[1]*u[1]*IJ(x,4,1,0)*sin(r[0])*sin(r[2]) - t[0]*u[2]*IJ(x,4,2,2)*sin(r[0])*sin(r[1]) + t[1]*u[2]*IJ(x,4,2,0)*sin(r[0])*sin(r[2]) - t[1]*u[0]*IJ(x,4,0,0)*cos(r[0])*cos(r[1])*cos(r[2]) - t[1]*u[1]*IJ(x,4,1,0)*cos(r[0])*cos(r[1])*cos(r[2]) - t[1]*u[2]*IJ(x,4,2,0)*cos(r[0])*cos(r[1])*cos(r[2]) + t[0]*u[0]*IJ(x,4,0,0)*cos(r[1])*cos(r[2])*sin(r[0]) + t[1]*u[0]*IJ(x,4,0,1)*cos(r[0])*cos(r[1])*sin(r[2]) + t[0]*u[1]*IJ(x,4,1,0)*cos(r[1])*cos(r[2])*sin(r[0]) + t[1]*u[1]*IJ(x,4,1,1)*cos(r[0])*cos(r[1])*sin(r[2]) + t[0]*u[2]*IJ(x,4,2,0)*cos(r[1])*cos(r[2])*sin(r[0]) + t[1]*u[2]*IJ(x,4,2,1)*cos(r[0])*cos(r[1])*sin(r[2]) - t[0]*u[0]*IJ(x,4,0,1)*cos(r[1])*sin(r[0])*sin(r[2]) - t[0]*u[1]*IJ(x,4,1,1)*cos(r[1])*sin(r[0])*sin(r[2]) - t[0]*u[2]*IJ(x,4,2,1)*cos(r[1])*sin(r[0])*sin(r[2]) ; IJ(D,10,9,4) = t[2]*u[0]*IJ(x,4,0,2)*sin(r[1]) + t[2]*u[1]*IJ(x,4,1,2)*sin(r[1]) + t[2]*u[2]*IJ(x,4,2,2)*sin(r[1]) + t[0]*u[0]*IJ(x,4,0,2)*cos(r[0])*cos(r[1]) + t[0]*u[1]*IJ(x,4,1,2)*cos(r[0])*cos(r[1]) - t[2]*u[0]*IJ(x,4,0,0)*cos(r[1])*cos(r[2]) + t[0]*u[2]*IJ(x,4,2,2)*cos(r[0])*cos(r[1]) - t[2]*u[1]*IJ(x,4,1,0)*cos(r[1])*cos(r[2]) - t[2]*u[2]*IJ(x,4,2,0)*cos(r[1])*cos(r[2]) + t[1]*u[0]*IJ(x,4,0,2)*cos(r[1])*sin(r[0]) + t[1]*u[1]*IJ(x,4,1,2)*cos(r[1])*sin(r[0]) + t[2]*u[0]*IJ(x,4,0,1)*cos(r[1])*sin(r[2]) + t[1]*u[2]*IJ(x,4,2,2)*cos(r[1])*sin(r[0]) + t[2]*u[1]*IJ(x,4,1,1)*cos(r[1])*sin(r[2]) + t[2]*u[2]*IJ(x,4,2,1)*cos(r[1])*sin(r[2]) + t[0]*u[0]*IJ(x,4,0,0)*cos(r[0])*cos(r[2])*sin(r[1]) + t[0]*u[1]*IJ(x,4,1,0)*cos(r[0])*cos(r[2])*sin(r[1]) + t[0]*u[2]*IJ(x,4,2,0)*cos(r[0])*cos(r[2])*sin(r[1]) - t[0]*u[0]*IJ(x,4,0,1)*cos(r[0])*sin(r[1])*sin(r[2]) + t[1]*u[0]*IJ(x,4,0,0)*cos(r[2])*sin(r[0])*sin(r[1]) - t[0]*u[1]*IJ(x,4,1,1)*cos(r[0])*sin(r[1])*sin(r[2]) + t[1]*u[1]*IJ(x,4,1,0)*cos(r[2])*sin(r[0])*sin(r[1]) - t[0]*u[2]*IJ(x,4,2,1)*cos(r[0])*sin(r[1])*sin(r[2]) + t[1]*u[2]*IJ(x,4,2,0)*cos(r[2])*sin(r[0])*sin(r[1]) - t[1]*u[0]*IJ(x,4,0,1)*sin(r[0])*sin(r[1])*sin(r[2]) - t[1]*u[1]*IJ(x,4,1,1)*sin(r[0])*sin(r[1])*sin(r[2]) - t[1]*u[2]*IJ(x,4,2,1)*sin(r[0])*sin(r[1])*sin(r[2]) ; IJ(D,10,9,5) = t[0]*u[0]*IJ(x,4,0,0)*cos(r[2])*sin(r[0]) - t[1]*u[1]*IJ(x,4,1,0)*cos(r[0])*cos(r[2]) - t[1]*u[2]*IJ(x,4,2,0)*cos(r[0])*cos(r[2]) - t[1]*u[0]*IJ(x,4,0,0)*cos(r[0])*cos(r[2]) + t[1]*u[0]*IJ(x,4,0,1)*cos(r[0])*sin(r[2]) + t[0]*u[1]*IJ(x,4,1,0)*cos(r[2])*sin(r[0]) + t[1]*u[1]*IJ(x,4,1,1)*cos(r[0])*sin(r[2]) + t[2]*u[0]*IJ(x,4,0,1)*cos(r[2])*sin(r[1]) + t[0]*u[2]*IJ(x,4,2,0)*cos(r[2])*sin(r[0]) + t[1]*u[2]*IJ(x,4,2,1)*cos(r[0])*sin(r[2]) + t[2]*u[1]*IJ(x,4,1,1)*cos(r[2])*sin(r[1]) + t[2]*u[2]*IJ(x,4,2,1)*cos(r[2])*sin(r[1]) - t[0]*u[0]*IJ(x,4,0,1)*sin(r[0])*sin(r[2]) - t[0]*u[1]*IJ(x,4,1,1)*sin(r[0])*sin(r[2]) + t[2]*u[0]*IJ(x,4,0,0)*sin(r[1])*sin(r[2]) - t[0]*u[2]*IJ(x,4,2,1)*sin(r[0])*sin(r[2]) + t[2]*u[1]*IJ(x,4,1,0)*sin(r[1])*sin(r[2]) + t[2]*u[2]*IJ(x,4,2,0)*sin(r[1])*sin(r[2]) + t[0]*u[0]*IJ(x,4,0,1)*cos(r[0])*cos(r[1])*cos(r[2]) + t[0]*u[1]*IJ(x,4,1,1)*cos(r[0])*cos(r[1])*cos(r[2]) + t[0]*u[2]*IJ(x,4,2,1)*cos(r[0])*cos(r[1])*cos(r[2]) + t[0]*u[0]*IJ(x,4,0,0)*cos(r[0])*cos(r[1])*sin(r[2]) + t[1]*u[0]*IJ(x,4,0,1)*cos(r[1])*cos(r[2])*sin(r[0]) + t[0]*u[1]*IJ(x,4,1,0)*cos(r[0])*cos(r[1])*sin(r[2]) + t[1]*u[1]*IJ(x,4,1,1)*cos(r[1])*cos(r[2])*sin(r[0]) + t[0]*u[2]*IJ(x,4,2,0)*cos(r[0])*cos(r[1])*sin(r[2]) + t[1]*u[2]*IJ(x,4,2,1)*cos(r[1])*cos(r[2])*sin(r[0]) + t[1]*u[0]*IJ(x,4,0,0)*cos(r[1])*sin(r[0])*sin(r[2]) + t[1]*u[1]*IJ(x,4,1,0)*cos(r[1])*sin(r[0])*sin(r[2]) + t[1]*u[2]*IJ(x,4,2,0)*cos(r[1])*sin(r[0])*sin(r[2]) ; IJ(D,10,9,6) = IJ(x,4,0,3) - t[2]*IJ(x,4,0,2)*cos(r[1]) + t[0]*IJ(x,4,0,2)*cos(r[0])*sin(r[1]) + t[0]*IJ(x,4,0,1)*cos(r[2])*sin(r[0]) - t[1]*IJ(x,4,0,0)*cos(r[0])*sin(r[2]) - t[2]*IJ(x,4,0,0)*cos(r[2])*sin(r[1]) + t[0]*IJ(x,4,0,0)*sin(r[0])*sin(r[2]) + t[1]*IJ(x,4,0,2)*sin(r[0])*sin(r[1]) + t[2]*IJ(x,4,0,1)*sin(r[1])*sin(r[2]) - t[1]*IJ(x,4,0,1)*cos(r[0])*cos(r[2]) - t[0]*IJ(x,4,0,0)*cos(r[0])*cos(r[1])*cos(r[2]) + t[0]*IJ(x,4,0,1)*cos(r[0])*cos(r[1])*sin(r[2]) - t[1]*IJ(x,4,0,0)*cos(r[1])*cos(r[2])*sin(r[0]) + t[1]*IJ(x,4,0,1)*cos(r[1])*sin(r[0])*sin(r[2]) ; IJ(D,10,9,7) = IJ(x,4,1,3) - t[2]*IJ(x,4,1,2)*cos(r[1]) + t[0]*IJ(x,4,1,2)*cos(r[0])*sin(r[1]) + t[0]*IJ(x,4,1,1)*cos(r[2])*sin(r[0]) - t[1]*IJ(x,4,1,0)*cos(r[0])*sin(r[2]) - t[2]*IJ(x,4,1,0)*cos(r[2])*sin(r[1]) + t[0]*IJ(x,4,1,0)*sin(r[0])*sin(r[2]) + t[1]*IJ(x,4,1,2)*sin(r[0])*sin(r[1]) + t[2]*IJ(x,4,1,1)*sin(r[1])*sin(r[2]) - t[1]*IJ(x,4,1,1)*cos(r[0])*cos(r[2]) - t[0]*IJ(x,4,1,0)*cos(r[0])*cos(r[1])*cos(r[2]) + t[0]*IJ(x,4,1,1)*cos(r[0])*cos(r[1])*sin(r[2]) - t[1]*IJ(x,4,1,0)*cos(r[1])*cos(r[2])*sin(r[0]) + t[1]*IJ(x,4,1,1)*cos(r[1])*sin(r[0])*sin(r[2]) ; IJ(D,10,9,8) = IJ(x,4,2,3) - t[2]*IJ(x,4,2,2)*cos(r[1]) + t[0]*IJ(x,4,2,2)*cos(r[0])*sin(r[1]) + t[0]*IJ(x,4,2,1)*cos(r[2])*sin(r[0]) - t[1]*IJ(x,4,2,0)*cos(r[0])*sin(r[2]) - t[2]*IJ(x,4,2,0)*cos(r[2])*sin(r[1]) + t[0]*IJ(x,4,2,0)*sin(r[0])*sin(r[2]) + t[1]*IJ(x,4,2,2)*sin(r[0])*sin(r[1]) + t[2]*IJ(x,4,2,1)*sin(r[1])*sin(r[2]) - t[1]*IJ(x,4,2,1)*cos(r[0])*cos(r[2]) - t[0]*IJ(x,4,2,0)*cos(r[0])*cos(r[1])*cos(r[2]) + t[0]*IJ(x,4,2,1)*cos(r[0])*cos(r[1])*sin(r[2]) - t[1]*IJ(x,4,2,0)*cos(r[1])*cos(r[2])*sin(r[0]) + t[1]*IJ(x,4,2,1)*cos(r[1])*sin(r[0])*sin(r[2]) ; 
    }
}

void mexFunction( int nlhs, mxArray *plhs[],
                  int nrhs, const mxArray *prhs[] )
{
  mxArray *offset, *u;
  size_t m, n;
    
  /* Check for proper number of arguments. */
  if(nrhs!=2) {
    mexErrMsgTxt("Two inputs required.");
  } else if(nlhs>3) {
    mexErrMsgTxt("Too many output arguments.");
  }
  
  /* The first input must be a SE(n) */
  m = mxGetM(prhs[0]);
  n = mxGetN(prhs[0]);
  if (!mxIsDouble(prhs[0]) || mxIsComplex(prhs[1]) || !((m == 3 && n == 3) || (m == 4 && n ==4))) {
      mexErrMsgTxt("x must be a 3x3 or 4x4 real double matrix.");
  }
  
  /* The second input must be a 1x2 cell with a SE(n) and a R(n) in it.*/
  if (!mxIsCell(prhs[1]) || mxGetNumberOfDimensions(prhs[1]) != 2 || mxGetM(prhs[1]) != 1 || mxGetN(prhs[1]) != 2) {
      mexErrMsgTxt("params must be a 1x2 cell array.");
  }
  offset = mxGetCell(prhs[1], 0);
  m = mxGetM(offset);
  n = mxGetN(offset);
  if (!mxIsDouble(offset) || mxIsComplex(offset) || !((m == 3 && n == 3) || (m == 4 && n == 4))) {
      mexErrMsgTxt("params{1} must be a 3x3 or 4x4 real double matrix.");
  }
  u = mxGetCell(prhs[1], 1);
  n = mxGetN(u) + 1;
  if (!mxIsDouble(u) || mxIsComplex(u) || n != m) {
      mexErrMsgTxt("params{2} must be a real double unit vector with dimension corresponding to params{1}.");
  }

  /* Create matrices for return arguments. */
  plhs[0] = mxCreateDoubleMatrix(1, 1, mxREAL);
  if (nrhs == 2) {
      size_t d = n*(n-1)/2;
      plhs[1] = mxCreateDoubleMatrix(d+n, d+n-1, mxREAL);
  }
  
  /* Call subroutine(s). */
  inverse_prismatic(m-1, mxGetPr(prhs[0]), mxGetPr(offset), mxGetPr(u), mxGetPr(plhs[0]));
  if (nrhs == 2) {
      mxArray* lhs[2];
      
      if (mexCallMATLAB(2, lhs, 1, &offset, "extract_SE") != 0) {
          mexErrMsgTxt("failed to call extract_SE");
      }

      inverse_prismatic_gradient(m-1, mxGetPr(prhs[0]), mxGetPr(u), mxGetPr(lhs[0]), mxGetPr(lhs[1]), mxGetPr(plhs[1]));
  }
}
